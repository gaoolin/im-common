# QTech 配置管理使用手册

## 1. 简介

QTech 配置管理系统提供了一套完整的配置管理解决方案，支持多种配置源、动态配置更新、配置监听等功能。该系统具有以下特点：

- 多配置源支持（Properties文件、系统属性、环境变量等）
- 配置优先级管理
- 热更新支持
- 配置变更监听
- 类型安全的配置访问
- 多环境配置支持

## 2. 核心组件

### 2.1 ConfigurationManager（配置管理器）
配置管理的核心接口，提供配置的获取、更新和管理功能。

### 2.2 ConfigSource（配置源）
表示一个配置来源，如Properties文件、系统属性等。

### 2.3 ConfigurationListener（配置监听器）
监听配置变更事件的接口。

## 3. 快速开始

### 3.1 添加依赖

在项目中添加必要的依赖：

```xml
<dependency>
    <groupId>com.qtech</groupId>
    <artifactId>im-common</artifactId>
    <version>1.0.0</version>
</dependency>
```


### 3.2 基本使用

```java
import com.qtech.im.config.ConfigurationManager;
import com.qtech.im.config.impl.DefaultConfigurationManager;

// 创建配置管理器实例
ConfigurationManager configManager = new DefaultConfigurationManager();

// 获取配置值
String appName = configManager.getString("app.name");
Integer port = configManager.getInteger("server.port", 8080);
Boolean debug = configManager.getBoolean("app.debug", false);

System.out.println("应用名称: " + appName);
System.out.println("服务端口: " + port);
System.out.println("调试模式: " + debug);
```


## 4. 配置源管理

### 4.1 内置配置源

系统提供了多种内置配置源：

#### PropertiesFileConfigSource（Properties文件配置源）
```java
import com.qtech.im.config.source.PropertiesFileConfigSource;

// 创建Properties文件配置源
ConfigSource propertiesSource = new PropertiesFileConfigSource("config/application.properties");
configManager.addConfigSource(propertiesSource);
```


#### SystemPropertyConfigSource（系统属性配置源）
```java
import com.qtech.im.config.source.SystemPropertyConfigSource;

// 系统属性配置源已默认添加
// 可以手动添加以调整优先级
ConfigSource systemSource = new SystemPropertyConfigSource();
configManager.addConfigSource(systemSource);
```


### 4.2 自定义配置源

```java
import com.qtech.im.config.ConfigSource;

// 实现自定义配置源
ConfigSource customSource = new ConfigSource() {
    @Override
    public String getName() {
        return "custom-config-source";
    }

    @Override
    public String getProperty(String key) {
        // 自定义获取配置逻辑
        return getProperties().get(key);
    }

    @Override
    public Map<String, String> getProperties() {
        Map<String, String> properties = new HashMap<>();
        // 从自定义来源加载配置
        properties.put("custom.key", "custom.value");
        return properties;
    }

    @Override
    public Set<String> getPropertyNames() {
        return getProperties().keySet();
    }

    @Override
    public void refresh() {
        // 刷新配置逻辑
    }

    @Override
    public boolean isAvailable() {
        // 检查配置源是否可用
        return true;
    }

    @Override
    public int getPriority() {
        // 设置优先级，数值越大优先级越高
        return 75;
    }
};

// 添加自定义配置源
configManager.addConfigSource(customSource);
```


## 5. 配置获取

### 5.1 基本类型配置获取

```java
ConfigurationManager configManager = new DefaultConfigurationManager();

// 字符串类型
String stringValue = configManager.getString("app.name");
String stringValueWithDefault = configManager.getString("app.name", "default-app");

// 整数类型
Integer intValue = configManager.getInteger("server.port");
Integer intValueWithDefault = configManager.getInteger("server.port", 8080);

// 长整数类型
Long longValue = configManager.getLong("app.max-memory");
Long longValueWithDefault = configManager.getLong("app.max-memory", 1024L);

// 布尔类型
Boolean boolValue = configManager.getBoolean("app.debug");
Boolean boolValueWithDefault = configManager.getBoolean("app.debug", false);

// 双精度浮点类型
Double doubleValue = configManager.getDouble("app.rate");
Double doubleValueWithDefault = configManager.getDouble("app.rate", 1.0);
```


### 5.2 泛型类型配置获取

```java
// 使用泛型方法获取配置
String appName = configManager.getValue("app.name", String.class);
Integer port = configManager.getValue("server.port", Integer.class, 8080);
Boolean debug = configManager.getValue("app.debug", Boolean.class, false);
```


### 5.3 兼容性方法

```java
// 兼容旧版配置获取方法
String value = configManager.getProperty("app.name");
String valueWithDefault = configManager.getProperty("app.name", "default-value");
int intProp = configManager.getIntProperty("server.port", 8080);
boolean boolProp = configManager.getBooleanProperty("app.debug", false);
```


## 6. 多环境配置

### 6.1 环境切换

```java
ConfigurationManager configManager = new DefaultConfigurationManager("dev");

// 运行时切换环境
configManager.setActiveProfile("prod");
```


### 6.2 配置文件命名规范

- 默认配置文件: `application.properties`
- 环境特定配置文件: `application-{profile}.properties`
  - 开发环境: `application-dev.properties`
  - 测试环境: `application-test.properties`
  - 生产环境: `application-prod.properties`

## 7. 配置监听

### 7.1 添加配置监听器

```java
import com.qtech.im.config.ConfigurationListener;
import com.qtech.im.config.ConfigurationEvent;

// 创建配置监听器
ConfigurationListener listener = new ConfigurationListener() {
    @Override
    public void onConfigurationChanged(ConfigurationEvent event) {
        System.out.println("配置发生变更: " + event.getChangedKeys());
        // 处理配置变更逻辑
    }
};

// 添加监听器
configManager.addConfigurationListener(listener);
```


### 7.2 配置刷新

```java
// 手动刷新所有配置源
configManager.refresh();

// 重新加载配置
configManager.reloadConfiguration();
```


## 8. 配置优先级

配置系统支持优先级机制，优先级高的配置会覆盖优先级低的同名配置：

1. 系统属性 (优先级: 100)
2. Properties文件 (优先级: 50)
3. 环境变量 (优先级: 75)
4. 自定义配置源 (优先级: 可配置)

```java
// 配置源优先级示例
ConfigSource highPrioritySource = new ConfigSource() {
    // ... 实现细节
    
    @Override
    public int getPriority() {
        return 200; // 最高优先级
    }
};
```


## 9. 使用示例

### 9.1 完整使用示例

```java
import com.qtech.im.config.ConfigurationManager;
import com.qtech.im.config.ConfigurationListener;
import com.qtech.im.config.ConfigurationEvent;
import com.qtech.im.config.source.PropertiesFileConfigSource;

public class ConfigurationExample {
    public static void main(String[] args) {
        // 创建配置管理器
        ConfigurationManager configManager = new DefaultConfigurationManager("dev");
        
        // 添加额外的配置源
        ConfigSource extraSource = new PropertiesFileConfigSource("extra.properties", 75);
        configManager.addConfigSource(extraSource);
        
        // 添加配置监听器
        configManager.addConfigurationListener(new ConfigurationListener() {
            @Override
            public void onConfigurationChanged(ConfigurationEvent event) {
                System.out.println("配置变更事件: " + event);
            }
        });
        
        // 获取配置
        String appName = configManager.getString("app.name", "MyApp");
        Integer serverPort = configManager.getInteger("server.port", 8080);
        Boolean debugMode = configManager.getBoolean("app.debug", false);
        
        System.out.println("应用名称: " + appName);
        System.out.println("服务端口: " + serverPort);
        System.out.println("调试模式: " + debugMode);
        
        // 刷新配置
        configManager.refresh();
    }
}
```


### 9.2 配置文件示例

**application.properties**
```properties
# 应用配置
app.name=MyApplication
app.version=1.0.0
app.debug=false

# 服务器配置
server.port=8080
server.host=localhost

# 数据库配置
database.url=jdbc:mysql://localhost:3306/mydb
database.username=user
database.password=password
```


**application-dev.properties**
```properties
# 开发环境配置
app.debug=true
server.port=9090
database.url=jdbc:mysql://dev-server:3306/mydb
```


## 10. 最佳实践

### 10.1 配置组织
- 按功能模块组织配置项
- 使用统一的命名规范
- 为重要配置项提供默认值

### 10.2 性能优化
- 合理设置配置源优先级
- 避免频繁刷新配置
- 缓存频繁访问的配置项

### 10.3 安全考虑
- 敏感配置项（如密码）应加密存储
- 限制配置访问权限
- 审计配置变更历史

### 10.4 监控和日志
- 记录配置加载和变更日志
- 监控配置源的可用性
- 告警重要配置的变更

## 11. 故障排除

### 11.1 配置未生效
- 检查配置源优先级
- 确认配置文件路径正确
- 验证配置键名称正确

### 11.2 配置监听器未触发
- 确认监听器已正确添加
- 检查配置源是否支持刷新
- 验证配置确实发生了变更

### 11.3 性能问题
- 检查配置源刷新频率
- 优化配置项访问方式
- 考虑使用配置缓存

## 12. 扩展功能

### 12.1 集成Spring
```java
@Configuration
public class ConfigurationConfig {
    
    @Bean
    @Primary
    public ConfigurationManager configurationManager() {
        return new DefaultConfigurationManager();
    }
}
```


### 12.2 配置加密
```java
// 自定义配置源支持配置项解密
ConfigSource encryptedSource = new ConfigSource() {
    @Override
    public String getProperty(String key) {
        String encryptedValue = getProperties().get(key);
        if (encryptedValue != null) {
            // 解密逻辑
            return decrypt(encryptedValue);
        }
        return null;
    }
    
    // ... 其他方法实现
};
```


## 13. 注意事项

1. 配置管理器是线程安全的，可在多线程环境中使用
2. 配置源的优先级数值越大优先级越高
3. 配置变更监听依赖于配置源的刷新机制
4. 系统属性配置源默认已添加，优先级为100
5. 多环境配置文件需要按照命名规范放置在classpath中

## 14. 联系方式

如有问题或建议，请联系开发团队或提交 issue。