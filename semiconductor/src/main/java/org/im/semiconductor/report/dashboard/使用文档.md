# KpiDashboard 使用说明文档

## 1. 概述

[KpiDashboard](file://E:\dossier\others\im-common\src\main\java\com\qtech\im\semiconductor\report\dashboard\KpiDashboard.java#L30-L582)
是一个专业的KPI仪表板工具类，专门用于半导体封测行业的关键绩效指标监控、分析和预警。该工具解决了KPI指标分散难查看、数据实时性差、异常预警不及时和趋势分析困难等问题。

## 2. 核心功能

### 2.1 KPI指标计算

- 支持多种计算方法（平均值、总和、计数等）
- 可配置的计算周期和数据源
- 实时和历史数据计算

### 2.2 实时KPI监控

- 多级阈值预警（正常、警告、严重）
- 实时状态监控
- 自动预警通知

### 2.3 KPI趋势分析

- 历史数据分析
- 趋势预测和可视化
- 统计分析报告

### 2.4 仪表板展示

- 可配置的仪表板布局
- 多KPI统一展示
- 实时数据更新

## 3. 支持的KPI类型和计算方法

### 3.1 KPI类型

```java
public enum KpiType {
    PRODUCTION("生产类"),     // 如产量、生产效率等
    QUALITY("质量类"),       // 如良率、缺陷率等
    EQUIPMENT("设备类"),     // 如设备利用率、故障率等
    EFFICIENCY("效率类"),    // 如OEE、产能利用率等
    FINANCIAL("财务类"),     // 如成本、收益等
    CUSTOM("自定义类")       // 用户自定义类型
}
```

### 3.2 计算方法

```java
public enum KpiCalculationMethod {
    AVERAGE("平均值"),       // 平均值计算
    SUM("总和"),            // 总和计算
    COUNT("计数"),          // 计数统计
    MAX("最大值"),          // 最大值
    MIN("最小值"),          // 最小值
    PERCENTAGE("百分比"),    // 百分比计算
    RATIO("比率"),          // 比率计算
    TRENDED("趋势值"),       // 趋势分析
    CUMULATIVE("累积值")     // 累积值计算
}
```

## 4. 基本使用方法

### 4.1 定义和注册KPI

```java
// 定义KPI指标
KpiDashboard.KpiDefinition yieldKpi = new KpiDashboard.KpiDefinition(
    "YIELD_001",                           // KPI ID
    "产品良率",                            // KPI名称
    KpiDashboard.KpiType.QUALITY,          // KPI类型
    KpiDashboard.KpiCalculationMethod.PERCENTAGE, // 计算方法
    "PRODUCTION_DB"                        // 数据源
)
.setParameter("productLine", "LINE_A")     // 自定义参数
.setParameter("timeWindow", "24h")
.setUnit("%")                              // 单位
.setDescription("A线24小时产品良率监控");    // 描述

// 注册KPI定义
boolean registered = KpiDashboard.registerKpiDefinition(yieldKpi);
if (registered) {
    System.out.println("KPI定义注册成功: " + yieldKpi.getKpiName());
} else {
    System.err.println("KPI定义注册失败");
}
```

### 4.2 KPI指标计算

```java
// 创建时间范围
KpiDashboard.TimeRange timeRange = new KpiDashboard.TimeRange(
    LocalDateTime.now().minusHours(24),    // 24小时前
    LocalDateTime.now()                    // 现在
);

// 计算KPI值
KpiDashboard.KpiValue kpiValue = KpiDashboard.calculateKpi(yieldKpi, timeRange);

if (kpiValue != null) {
    System.out.println("KPI计算结果:");
    System.out.println("  KPI名称: " + kpiValue.getKpiName());
    System.out.println("  当前值: " + kpiValue.getFormattedValue() + kpiValue.getUnit());
    System.out.println("  状态: " + kpiValue.getStatus().getDescription());
    System.out.println("  计算时间: " + kpiValue.getTimestamp());
    
    if (kpiValue.hasTarget()) {
        System.out.println("  目标值: " + kpiValue.getTargetValue());
        System.out.println("  差异: " + kpiValue.getVariance() + "%");
    }
} else {
    System.err.println("KPI计算失败");
}
```

### 4.3 实时KPI监控

```java
// 配置阈值
KpiDashboard.ThresholdConfig thresholds = new KpiDashboard.ThresholdConfig()
    .setNormalLowerBound(new BigDecimal("95.00"))      // 正常下限 95%
    .setNormalUpperBound(new BigDecimal("100.00"))     // 正常上限 100%
    .setWarningLowerBound(new BigDecimal("90.00"))     // 警告下限 90%
    .setWarningUpperBound(new BigDecimal("95.00"))     // 警告上限 95%
    .setCriticalLowerBound(new BigDecimal("85.00"))    // 严重下限 85%
    .setCriticalUpperBound(new BigDecimal("100.00"))   // 严重上限 100%
    .setEnableAlerts(true)                             // 启用预警
    .addAlertRecipient("production.manager@company.com")  // 预警接收者
    .addAlertRecipient("quality.manager@company.com")
    .setAlertMessageTemplate("KPI {kpiName} 异常，当前值: {currentValue}");

// 实时监控KPI
KpiDashboard.KpiAlert alert = KpiDashboard.monitorKpiRealTime("YIELD_001", thresholds);

if (alert != null) {
    System.out.println("触发预警:");
    System.out.println("  预警级别: " + alert.getAlertLevel().getDescription());
    System.out.println("  当前值: " + alert.getCurrentValue());
    System.out.println("  预警消息: " + alert.getMessage());
    System.out.println("  预警时间: " + alert.getTimestamp());
    System.out.println("  接收者: " + alert.getRecipients());
} else {
    System.out.println("KPI状态正常，无预警");
}
```

### 4.4 KPI趋势分析

```java
// 分析KPI趋势（最近7天）
KpiDashboard.TimeRange trendRange = new KpiDashboard.TimeRange(
    LocalDateTime.now().minusDays(7),      // 7天前
    LocalDateTime.now()                    // 现在
);

KpiDashboard.KpiTrend kpiTrend = KpiDashboard.analyzeKpiTrend("YIELD_001", trendRange);

if (kpiTrend != null) {
    System.out.println("KPI趋势分析结果:");
    System.out.println("  KPI名称: " + kpiTrend.getKpiName());
    System.out.println("  数据点数: " + kpiTrend.getHistoricalValues().size());
    System.out.println("  趋势斜率: " + kpiTrend.getTrendSlope());
    System.out.println("  趋势方向: " + kpiTrend.getTrendDirection());
    System.out.println("  分析时间范围: " + kpiTrend.getStartTime() + " 到 " + kpiTrend.getEndTime());
    
    // 显示最近几个数据点
    List<KpiDashboard.KpiValue> recentValues = kpiTrend.getHistoricalValues();
    System.out.println("  最近数据:");
    recentValues.stream()
        .skip(Math.max(0, recentValues.size() - 5)) // 显示最近5个数据点
        .forEach(value -> System.out.println("    " + value.getTimestamp() + ": " + value.getFormattedValue()));
}
```

### 4.5 仪表板生成

```java
// 创建仪表板配置
KpiDashboard.DashboardConfig dashboardConfig = new KpiDashboard.DashboardConfig()
    .setDashboardId("PROD_DASHBOARD_001")
    .setDashboardName("生产监控仪表板")
    .setLayout("grid")  // 网格布局
    .addKpiId("YIELD_001")     // 添加良率KPI
    .addKpiId("OEE_001")       // 添加设备效率KPI
    .addKpiId("THROUGHPUT_001") // 添加产量KPI
    .setEnableRealTimeUpdates(true)  // 启用实时更新
    .setUpdateInterval(60000)        // 1分钟更新一次
    .addAuthorizedUser("manager")
    .addAuthorizedUser("supervisor")
    .setDisplaySetting("theme", "dark")
    .setDisplaySetting("refreshRate", "60s");

// 生成仪表板
KpiDashboard.Dashboard dashboard = KpiDashboard.generateDashboard(dashboardConfig);

if (dashboard != null) {
    System.out.println("仪表板生成成功:");
    System.out.println("  仪表板ID: " + dashboard.getDashboardId());
    System.out.println("  仪表板名称: " + dashboard.getDashboardName());
    System.out.println("  KPI数量: " + dashboard.getKpiValues().size());
    System.out.println("  布局: " + dashboard.getLayout());
    System.out.println("  最后更新: " + dashboard.getLastUpdated());
    
    // 显示所有KPI值
    for (KpiDashboard.KpiValue kpiValue : dashboard.getKpiValues()) {
        System.out.println("  - " + kpiValue.getKpiName() + ": " + 
                          kpiValue.getFormattedValue() + " " + 
                          kpiValue.getUnit() + " (" + 
                          kpiValue.getStatus().getDescription() + ")");
    }
}
```

## 5. 高级使用示例

### 5.1 批量KPI监控

```java
public class BatchKpiMonitor {
    public void monitorProductionKpis() {
        // 定义多个KPI
        List<KpiDashboard.KpiDefinition> kpiDefinitions = Arrays.asList(
            createYieldKpi(),
            createOeeKpi(),
            createThroughputKpi()
        );
        
        // 注册所有KPI
        for (KpiDashboard.KpiDefinition kpiDef : kpiDefinitions) {
            KpiDashboard.registerKpiDefinition(kpiDef);
        }
        
        // 为每个KPI设置阈值并监控
        Map<String, KpiDashboard.ThresholdConfig> thresholdMap = createThresholdConfigs();
        
        List<KpiDashboard.KpiAlert> alerts = new ArrayList<>();
        for (KpiDashboard.KpiDefinition kpiDef : kpiDefinitions) {
            KpiDashboard.ThresholdConfig thresholds = thresholdMap.get(kpiDef.getKpiId());
            if (thresholds != null) {
                KpiDashboard.KpiAlert alert = KpiDashboard.monitorKpiRealTime(kpiDef.getKpiId(), thresholds);
                if (alert != null) {
                    alerts.add(alert);
                }
            }
        }
        
        // 处理预警
        if (!alerts.isEmpty()) {
            System.out.println("发现 " + alerts.size() + " 个KPI预警:");
            for (KpiDashboard.KpiAlert alert : alerts) {
                handleKpiAlert(alert);
            }
        } else {
            System.out.println("所有KPI状态正常");
        }
    }
    
    private KpiDashboard.KpiDefinition createYieldKpi() {
        return new KpiDashboard.KpiDefinition("YIELD_001", "产品良率", 
                                            KpiDashboard.KpiType.QUALITY,
                                            KpiDashboard.KpiCalculationMethod.PERCENTAGE,
                                            "PRODUCTION_DB");
    }
    
    private KpiDashboard.KpiDefinition createOeeKpi() {
        return new KpiDashboard.KpiDefinition("OEE_001", "设备综合效率", 
                                            KpiDashboard.KpiType.EFFICIENCY,
                                            KpiDashboard.KpiCalculationMethod.PERCENTAGE,
                                            "EQUIPMENT_DB");
    }
    
    private KpiDashboard.KpiDefinition createThroughputKpi() {
        return new KpiDashboard.KpiDefinition("THROUGHPUT_001", "小时产量", 
                                            KpiDashboard.KpiType.PRODUCTION,
                                            KpiDashboard.KpiCalculationMethod.AVERAGE,
                                            "PRODUCTION_DB");
    }
    
    private Map<String, KpiDashboard.ThresholdConfig> createThresholdConfigs() {
        Map<String, KpiDashboard.ThresholdConfig> configs = new HashMap<>();
        
        // 良率阈值
        configs.put("YIELD_001", new KpiDashboard.ThresholdConfig()
            .setNormalLowerBound(new BigDecimal("95.00"))
            .setWarningLowerBound(new BigDecimal("90.00"))
            .setCriticalLowerBound(new BigDecimal("85.00"))
            .setEnableAlerts(true)
            .addAlertRecipient("quality.manager@company.com"));
        
        // OEE阈值
        configs.put("OEE_001", new KpiDashboard.ThresholdConfig()
            .setNormalLowerBound(new BigDecimal("85.00"))
            .setWarningLowerBound(new BigDecimal("75.00"))
            .setCriticalLowerBound(new BigDecimal("65.00"))
            .setEnableAlerts(true)
            .addAlertRecipient("production.manager@company.com"));
        
        // 产量阈值
        configs.put("THROUGHPUT_001", new KpiDashboard.ThresholdConfig()
            .setNormalLowerBound(new BigDecimal("1000"))
            .setWarningLowerBound(new BigDecimal("800"))
            .setCriticalLowerBound(new BigDecimal("600"))
            .setEnableAlerts(true)
            .addAlertRecipient("production.supervisor@company.com"));
        
        return configs;
    }
    
    private void handleKpiAlert(KpiDashboard.KpiAlert alert) {
        System.out.println("=== KPI预警 ===");
        System.out.println("KPI: " + alert.getKpiName());
        System.out.println("级别: " + alert.getAlertLevel().getDescription());
        System.out.println("当前值: " + alert.getCurrentValue());
        System.out.println("消息: " + alert.getMessage());
        System.out.println("时间: " + alert.getTimestamp());
        System.out.println("接收者: " + alert.getRecipients());
        System.out.println();
    }
}
```

### 5.2 KPI历史数据分析

```java
public class KpiHistoricalAnalyzer {
    public void analyzeKpiPerformance(String kpiId, int days) {
        try {
            // 获取历史数据
            KpiDashboard.TimeRange analysisRange = new KpiDashboard.TimeRange(
                LocalDateTime.now().minusDays(days),
                LocalDateTime.now()
            );
            
            List<KpiDashboard.KpiValue> historicalData = 
                KpiDashboard.getHistoricalKpiValues(kpiId, analysisRange);
            
            if (historicalData.isEmpty()) {
                System.out.println("未找到历史数据");
                return;
            }
            
            System.out.println("=== " + kpiId + " 历史数据分析 (最近" + days + "天) ===");
            
            // 计算统计指标
            calculateStatistics(historicalData);
            
            // 分析趋势
            analyzeTrends(historicalData);
            
            // 识别异常值
            identifyOutliers(historicalData);
            
        } catch (Exception e) {
            System.err.println("分析过程中发生错误: " + e.getMessage());
            e.printStackTrace();
        }
    }
    
    private void calculateStatistics(List<KpiDashboard.KpiValue> data) {
        // 过滤有效数值
        List<BigDecimal> values = data.stream()
            .map(KpiDashboard.KpiValue::getValue)
            .filter(value -> value instanceof Number)
            .map(value -> new BigDecimal(value.toString()))
            .collect(Collectors.toList());
        
        if (values.isEmpty()) {
            System.out.println("无有效数值数据");
            return;
        }
        
        BigDecimal sum = values.stream().reduce(BigDecimal.ZERO, BigDecimal::add);
        BigDecimal average = sum.divide(new BigDecimal(values.size()), 4, BigDecimal.ROUND_HALF_UP);
        BigDecimal min = values.stream().min(BigDecimal::compareTo).orElse(BigDecimal.ZERO);
        BigDecimal max = values.stream().max(BigDecimal::compareTo).orElse(BigDecimal.ZERO);
        
        System.out.println("统计信息:");
        System.out.println("  数据点数: " + values.size());
        System.out.println("  平均值: " + average);
        System.out.println("  最小值: " + min);
        System.out.println("  最大值: " + max);
        System.out.println("  范围: " + min + " - " + max);
    }
    
    private void analyzeTrends(List<KpiDashboard.KpiValue> data) {
        if (data.size() < 2) {
            System.out.println("数据点不足，无法进行趋势分析");
            return;
        }
        
        // 按时间排序
        List<KpiDashboard.KpiValue> sortedData = data.stream()
            .sorted(Comparator.comparing(KpiDashboard.KpiValue::getTimestamp))
            .collect(Collectors.toList());
        
        // 分析最近趋势
        int recentSize = Math.min(5, sortedData.size());
        List<KpiDashboard.KpiValue> recentData = sortedData.subList(
            sortedData.size() - recentSize, sortedData.size());
        
        System.out.println("近期趋势分析:");
        System.out.println("  最近 " + recentSize + " 个数据点:");
        for (KpiDashboard.KpiValue value : recentData) {
            System.out.println("    " + value.getTimestamp().toLocalDate() + ": " + 
                              value.getFormattedValue());
        }
    }
    
    private void identifyOutliers(List<KpiDashboard.KpiValue> data) {
        // 简单的异常值检测（超过2个标准差）
        List<BigDecimal> values = data.stream()
            .map(KpiDashboard.KpiValue::getValue)
            .filter(value -> value instanceof Number)
            .map(value -> new BigDecimal(value.toString()))
            .collect(Collectors.toList());
        
        if (values.size() < 10) {
            System.out.println("数据点不足，跳过异常值检测");
            return;
        }
        
        // 计算均值和标准差
        BigDecimal sum = values.stream().reduce(BigDecimal.ZERO, BigDecimal::add);
        BigDecimal mean = sum.divide(new BigDecimal(values.size()), 6, BigDecimal.ROUND_HALF_UP);
        
        BigDecimal sumSquaredDiffs = values.stream()
            .map(value -> value.subtract(mean))
            .map(diff -> diff.multiply(diff))
            .reduce(BigDecimal.ZERO, BigDecimal::add);
        
        BigDecimal variance = sumSquaredDiffs.divide(new BigDecimal(values.size()), 6, BigDecimal.ROUND_HALF_UP);
        BigDecimal stdDev = new BigDecimal(Math.sqrt(variance.doubleValue()));
        
        BigDecimal upperBound = mean.add(stdDev.multiply(new BigDecimal("2")));
        BigDecimal lowerBound = mean.subtract(stdDev.multiply(new BigDecimal("2")));
        
        System.out.println("异常值检测:");
        System.out.println("  均值: " + mean);
        System.out.println("  标准差: " + stdDev);
        System.out.println("  正常范围: " + lowerBound + " - " + upperBound);
        
        // 查找异常值
        List<KpiDashboard.KpiValue> outliers = data.stream()
            .filter(kpiValue -> {
                if (!(kpiValue.getValue() instanceof Number)) return false;
                BigDecimal value = new BigDecimal(kpiValue.getValue().toString());
                return value.compareTo(upperBound) > 0 || value.compareTo(lowerBound) < 0;
            })
            .collect(Collectors.toList());
        
        if (outliers.isEmpty()) {
            System.out.println("  未发现异常值");
        } else {
            System.out.println("  发现 " + outliers.size() + " 个异常值:");
            outliers.forEach(outlier -> 
                System.out.println("    " + outlier.getTimestamp() + ": " + 
                                 outlier.getFormattedValue()));
        }
    }
}
```

## 6. 配置参数详解

### 6.1 KpiDefinition 配置项

```java
KpiDashboard.KpiDefinition kpiDef = new KpiDashboard.KpiDefinition(
    "KPI_ID",                    // KPI唯一标识符
    "KPI名称",                   // KPI显示名称
    KpiDashboard.KpiType.CUSTOM, // KPI类型
    KpiDashboard.KpiCalculationMethod.AVERAGE, // 计算方法
    "数据源"                     // 数据源标识
)
.setDescription("KPI描述")       // 详细描述
.setUnit("单位")                 // 数据单位
.setParameter("param1", "value1") // 自定义参数
.setParameter("param2", 123)
.setRefreshInterval(60000);      // 刷新间隔（毫秒）
```

### 6.2 ThresholdConfig 阈值配置

```java
KpiDashboard.ThresholdConfig thresholds = new KpiDashboard.ThresholdConfig()
    .setNormalLowerBound(new BigDecimal("90.00"))    // 正常范围下限
    .setNormalUpperBound(new BigDecimal("100.00"))   // 正常范围上限
    .setWarningLowerBound(new BigDecimal("80.00"))   // 警告范围下限
    .setWarningUpperBound(new BigDecimal("90.00"))   // 警告范围上限
    .setCriticalLowerBound(new BigDecimal("70.00"))  // 严重范围下限
    .setCriticalUpperBound(new BigDecimal("80.00"))  // 严重范围上限
    .setEnableAlerts(true)                           // 启用预警
    .setAlertRecipients(Arrays.asList(               // 预警接收者列表
        "user1@company.com",
        "user2@company.com"
    ))
    .setAlertMessageTemplate("KPI异常通知: {kpiName} 当前值 {currentValue}"); // 预警消息模板
```

### 6.3 DashboardConfig 仪表板配置

```java
KpiDashboard.DashboardConfig dashboardConfig = new KpiDashboard.DashboardConfig()
    .setDashboardId("DASHBOARD_001")        // 仪表板ID
    .setDashboardName("监控仪表板")           // 仪表板名称
    .setKpiIds(Arrays.asList(               // 包含的KPI列表
        "KPI_001",
        "KPI_002"
    ))
    .setLayout("grid")                      // 布局类型
    .setDisplaySetting("theme", "dark")     // 显示设置
    .setDisplaySetting("fontSize", "14px")
    .setEnableRealTimeUpdates(true)         // 启用实时更新
    .setUpdateInterval(30000)               // 更新间隔（毫秒）
    .setAuthorizedUsers(Arrays.asList(      // 授权用户
        "admin",
        "manager"
    ));
```

## 7. 错误处理

### 7.1 KPI计算错误处理

```java
public class KpiErrorHandler {
    public void handleKpiCalculation(KpiDashboard.KpiDefinition kpiDef) {
        try {
            KpiDashboard.KpiValue kpiValue = KpiDashboard.calculateKpi(kpiDef, null);
            
            if (kpiValue != null) {
                // 检查是否有错误元数据
                Object error = kpiValue.getMetadata("error");
                if (error != null) {
                    System.err.println("KPI计算警告: " + error);
                    // 可以选择继续使用默认值或采取其他措施
                } else {
                    System.out.println("KPI计算成功: " + kpiValue.getFormattedValue());
                }
            } else {
                System.err.println("KPI计算返回空值");
            }
        } catch (Exception e) {
            System.err.println("KPI计算异常: " + e.getMessage());
            e.printStackTrace();
            
            // 记录错误并采取降级措施
            handleCalculationError(kpiDef, e);
        }
    }
    
    private void handleCalculationError(KpiDashboard.KpiDefinition kpiDef, Exception e) {
        // 记录到日志系统
        System.err.println("[" + LocalDateTime.now() + "] KPI计算错误 - " + 
                          kpiDef.getKpiId() + ": " + e.getMessage());
        
        // 创建错误KPI值
        KpiDashboard.KpiValue errorValue = new KpiDashboard.KpiValue(
            kpiDef.getKpiId(),
            kpiDef.getKpiName(),
            "ERROR",
            kpiDef.getUnit(),
            KpiDashboard.KpiStatus.UNKNOWN,
            null
        );
        errorValue.setMetadata("error", e.getMessage());
        
        // 可以存储错误值用于监控
        System.out.println("已创建错误KPI值用于监控");
    }
}
```

## 8. 最佳实践

### 8.1 KPI定义最佳实践

```java
public class KpiBestPractices {
    public KpiDashboard.KpiDefinition createProductionKpi() {
        return new KpiDashboard.KpiDefinition(
            "PROD_YIELD_LINE_A",                    // 清晰的ID命名
            "A线产品良率",                          // 明确的名称
            KpiDashboard.KpiType.QUALITY,           // 正确的类型
            KpiDashboard.KpiCalculationMethod.PERCENTAGE, // 合适的计算方法
            "PRODUCTION_DATABASE"                   // 明确的数据源
        )
        .setDescription("监控A生产线的产品良率，目标值95%")  // 详细描述
        .setUnit("%")                              // 正确的单位
        .setParameter("line", "A")                 // 相关参数
        .setParameter("productType", "TYPE_X")
        .setParameter("timeWindow", "24h")
        .setParameter("targetValue", new BigDecimal("95.00"))  // 目标值
        .setRefreshInterval(300000);               // 5分钟刷新一次
    }
    
    public KpiDashboard.ThresholdConfig createYieldThresholds() {
        return new KpiDashboard.ThresholdConfig()
            .setNormalLowerBound(new BigDecimal("95.00"))      // 正常: 95-100%
            .setNormalUpperBound(new BigDecimal("100.00"))
            .setWarningLowerBound(new BigDecimal("90.00"))     // 警告: 90-95%
            .setWarningUpperBound(new BigDecimal("95.00"))
            .setCriticalLowerBound(new BigDecimal("85.00"))    // 严重: <85%
            .setCriticalUpperBound(new BigDecimal("100.00"))
            .setEnableAlerts(true)
            .setAlertRecipients(Arrays.asList(
                "production.manager@company.com",
                "quality.manager@company.com"
            ))
            .setAlertMessageTemplate("警告: {kpiName} 当前值 {currentValue}，低于目标值");
    }
}
```

### 8.2 仪表板安全控制

```java
public class SecureDashboardManager {
    public KpiDashboard.Dashboard generateSecureDashboard(
            String userId, String sessionId, KpiDashboard.DashboardConfig config) {
        
        // 1. 验证用户权限
        if (!hasDashboardAccess(userId, sessionId, config)) {
            System.err.println("用户 " + userId + " 无权访问仪表板");
            return null;
        }
        
        // 2. 过滤用户可访问的KPI
        List<String> accessibleKpis = filterAccessibleKpis(userId, config.getKpiIds());
        config.setKpiIds(accessibleKpis);
        
        // 3. 添加审计日志
        logDashboardAccess(userId, config.getDashboardId());
        
        // 4. 生成仪表板
        KpiDashboard.Dashboard dashboard = KpiDashboard.generateDashboard(config);
        
        if (dashboard != null) {
            // 5. 添加安全元数据
            dashboard.setMetadata("accessedBy", userId);
            dashboard.setMetadata("accessTime", LocalDateTime.now());
            dashboard.setMetadata("ipAddress", getCurrentUserIp());
        }
        
        return dashboard;
    }
    
    private boolean hasDashboardAccess(String userId, String sessionId, KpiDashboard.DashboardConfig config) {
        // 集成访问控制系统进行权限检查
        // 这里简化实现
        return userId != null && !userId.isEmpty() && 
               config.getAuthorizedUsers().contains(userId);
    }
    
    private List<String> filterAccessibleKpis(String userId, List<String> kpiIds) {
        // 根据用户权限过滤可访问的KPI
        // 这里简化实现，实际应用中应查询权限系统
        return kpiIds.stream()
            .filter(kpiId -> isKpiAccessible(userId, kpiId))
            .collect(Collectors.toList());
    }
    
    private boolean isKpiAccessible(String userId, String kpiId) {
        // 检查用户对特定KPI的访问权限
        // 简化实现
        return true;
    }
    
    private void logDashboardAccess(String userId, String dashboardId) {
        System.out.println("[" + LocalDateTime.now() + "] 用户 " + userId + 
                          " 访问仪表板 " + dashboardId);
        // 实际应用中应记录到审计日志系统
    }
    
    private String getCurrentUserIp() {
        // 获取当前用户IP地址
        return "127.0.0.1"; // 简化实现
    }
}
```

## 9. 系统集成

### 9.1 与Web服务集成

```java
@RestController
@RequestMapping("/api/kpi")
public class KpiDashboardController {
    
    @PostMapping("/calculate")
    public ResponseEntity<?> calculateKpi(@RequestBody KpiCalculationRequest request) {
        try {
            // 转换请求参数
            KpiDashboard.KpiDefinition kpiDef = convertToKpiDefinition(request.getKpiDefinition());
            KpiDashboard.TimeRange timeRange = convertToTimeRange(request.getTimeRange());
            
            // 计算KPI
            KpiDashboard.KpiValue kpiValue = KpiDashboard.calculateKpi(kpiDef, timeRange);
            
            if (kpiValue != null) {
                return ResponseEntity.ok(new KpiCalculationResponse(
                    kpiValue.getKpiId(),
                    kpiValue.getFormattedValue(),
                    kpiValue.getStatus().name(),
                    kpiValue.getTimestamp()
                ));
            } else {
                return ResponseEntity.badRequest().body("KPI计算失败");
            }
        } catch (Exception e) {
            return ResponseEntity.status(500).body("服务器内部错误: " + e.getMessage());
        }
    }
    
    @PostMapping("/monitor")
    public ResponseEntity<?> monitorKpi(@RequestBody KpiMonitorRequest request) {
        try {
            KpiDashboard.ThresholdConfig thresholds = convertToThresholdConfig(request.getThresholds());
            KpiDashboard.KpiAlert alert = KpiDashboard.monitorKpiRealTime(
                request.getKpiId(), thresholds);
            
            if (alert != null) {
                return ResponseEntity.ok(new KpiAlertResponse(
                    alert.getAlertId(),
                    alert.getAlertLevel().name(),
                    alert.getMessage(),
                    alert.getTimestamp()
                ));
            } else {
                return ResponseEntity.ok(new KpiAlertResponse(null, "NORMAL", "KPI状态正常", LocalDateTime.now()));
            }
        } catch (Exception e) {
            return ResponseEntity.status(500).body("监控失败: " + e.getMessage());
        }
    }
    
    @GetMapping("/dashboard/{id}")
    public ResponseEntity<?> getDashboard(@PathVariable String id, 
                                        @RequestParam(required = false) String userId,
                                        @RequestParam(required = false) String sessionId) {
        try {
            // 获取仪表板配置（从数据库或其他配置源）
            KpiDashboard.DashboardConfig config = getDashboardConfig(id);
            if (config == null) {
                return ResponseEntity.notFound().build();
            }
            
            // 安全检查和生成仪表板
            SecureDashboardManager secureManager = new SecureDashboardManager();
            KpiDashboard.Dashboard dashboard = secureManager.generateSecureDashboard(
                userId, sessionId, config);
            
            if (dashboard != null) {
                return ResponseEntity.ok(dashboard);
            } else {
                return ResponseEntity.status(403).body("无权访问");
            }
        } catch (Exception e) {
            return ResponseEntity.status(500).body("获取仪表板失败: " + e.getMessage());
        }
    }
    
    // 辅助方法
    private KpiDashboard.KpiDefinition convertToKpiDefinition(Object definition) {
        // 实现转换逻辑
        return null;
    }
    
    private KpiDashboard.TimeRange convertToTimeRange(Object timeRange) {
        // 实现转换逻辑
        return null;
    }
    
    private KpiDashboard.ThresholdConfig convertToThresholdConfig(Object thresholds) {
        // 实现转换逻辑
        return null;
    }
    
    private KpiDashboard.DashboardConfig getDashboardConfig(String id) {
        // 从存储中获取仪表板配置
        return null;
    }
}
```

### 9.2 与调度系统集成

```java
@Component
public class ScheduledKpiTasks {
    
    // 每5分钟计算一次关键KPI
    @Scheduled(fixedRate = 300000)
    public void calculateCriticalKpis() {
        System.out.println("开始计算关键KPI...");
        
        List<String> criticalKpiIds = Arrays.asList("YIELD_001", "OEE_001", "THROUGHPUT_001");
        
        for (String kpiId : criticalKpiIds) {
            try {
                KpiDashboard.KpiDefinition kpiDef = KpiDashboard.getKpiDefinition(kpiId);
                if (kpiDef != null) {
                    KpiDashboard.KpiValue kpiValue = KpiDashboard.calculateKpi(kpiDef, null);
                    if (kpiValue != null) {
                        System.out.println("KPI " + kpiId + " 计算完成: " + 
                                         kpiValue.getFormattedValue());
                    }
                }
            } catch (Exception e) {
                System.err.println("计算KPI " + kpiId + " 时发生错误: " + e.getMessage());
            }
        }
    }
    
    // 每小时检查一次KPI预警
    @Scheduled(cron = "0 0 * * * ?")
    public void checkKpiAlerts() {
        System.out.println("开始检查KPI预警...");
        
        List<KpiDashboard.KpiAlert> activeAlerts = KpiDashboard.getActiveAlerts();
        System.out.println("当前活动预警数量: " + activeAlerts.size());
        
        // 可以发送汇总报告
        if (!activeAlerts.isEmpty()) {
            sendAlertSummaryReport(activeAlerts);
        }
    }
    
    // 每天生成KPI报告
    @Scheduled(cron = "0 0 0 * * ?")
    public void generateDailyKpiReport() {
        System.out.println("生成每日KPI报告...");
        
        // 获取统计信息
        KpiDashboard.DashboardStatistics stats = KpiDashboard.getDashboardStatistics();
        System.out.println("KPI仪表板统计: " + stats);
        
        // 生成报告逻辑...
    }
    
    private void sendAlertSummaryReport(List<KpiDashboard.KpiAlert> alerts) {
        System.out.println("发送预警汇总报告，包含 " + alerts.size() + " 个预警");
        // 实现报告发送逻辑
    }
}
```

这个使用说明文档涵盖了 [KpiDashboard](file://E:\dossier\others\im-common\src\main\java\com\qtech\im\semiconductor\report\dashboard\KpiDashboard.java#L30-L582)
的主要功能和使用方法，可以帮助开发者快速上手并正确使用该KPI仪表板工具类。