# MesIntegrator 使用说明文档

## 1. 概述

[MesIntegrator](file://E:\dossier\others\im-common\src\main\java\com\qtech\im\semiconductor\integration\mes\MesIntegrator.java#L34-L1575)
是一个专业的MES（制造执行系统）集成工具类，专门用于半导体封测行业与MES系统的数据交互、指令处理、实时数据推送和异常处理。该工具解决了与MES系统数据交互复杂、数据格式转换困难、实时数据同步不及时和系统间异常处理不统一等问题。

## 2. 核心功能

### 2.1 MES数据同步

- 支持多种类型的数据包同步到MES系统
- 提供同步状态跟踪和结果反馈
- 支持批量数据同步处理

### 2.2 MES指令接收和处理

- 接收并处理来自MES系统的各种指令
- 支持多种类型的工艺控制指令
- 提供详细的指令处理响应

### 2.3 实时数据推送

- 实时推送生产、质量、设备等关键数据到MES
- 支持多种数据主题分类
- 提供消息队列机制保证数据不丢失

### 2.4 异常数据上报

- 自动捕获和上报系统异常
- 支持多种异常类型分类
- 提供异常处理状态跟踪

## 3. 支持的MES系统类型和数据类型

### 3.1 MES系统类型

```java
public enum MesType {
    SIEMENS_SIMATIC_IT("西门子SIMATIC IT", "Siemens SIMATIC IT"),
    ROCKWELL_FACTORYTALK("罗克韦尔FactoryTalk", "Rockwell FactoryTalk"),
    HONEYWELL_MEASUREMENT("霍尼韦尔MES", "Honeywell MES"),
    CAMSTAR("康思尔MES", "Camstar MES"),
    FACTORY_MES("工厂自研MES", "Factory MES"),
    CUSTOM("自定义MES", "Custom MES")
}
```

### 3.2 数据包类型

```java
public enum DataPackageType {
    PRODUCTION_DATA("生产数据", "Production Data"),
    QUALITY_DATA("质量数据", "Quality Data"),
    EQUIPMENT_DATA("设备数据", "Equipment Data"),
    MATERIAL_DATA("物料数据", "Material Data"),
    PROCESS_DATA("工艺数据", "Process Data"),
    DEFECT_DATA("缺陷数据", "Defect Data"),
    CUSTOM("自定义数据", "Custom Data")
}
```

### 3.3 指令类型

```java
public enum CommandType {
    START_PROCESS("启动工艺", "Start Process"),
    STOP_PROCESS("停止工艺", "Stop Process"),
    PAUSE_PROCESS("暂停工艺", "Pause Process"),
    RESUME_PROCESS("恢复工艺", "Resume Process"),
    ADJUST_PARAMETERS("调整参数", "Adjust Parameters"),
    QUALITY_HOLD("质量暂停", "Quality Hold"),
    QUALITY_RELEASE("质量放行", "Quality Release"),
    EQUIPMENT_MAINTENANCE("设备维护", "Equipment Maintenance"),
    CUSTOM("自定义指令", "Custom Command")
}
```

### 3.4 实时数据主题

```java
public enum RealTimeTopic {
    PRODUCTION_STATUS("生产状态", "Production Status"),
    QUALITY_METRICS("质量指标", "Quality Metrics"),
    EQUIPMENT_STATUS("设备状态", "Equipment Status"),
    MATERIAL_FLOW("物料流转", "Material Flow"),
    PROCESS_PARAMETERS("工艺参数", "Process Parameters"),
    ALARM_EVENTS("报警事件", "Alarm Events"),
    CUSTOM("自定义主题", "Custom Topic")
}
```

## 4. 基本使用方法

### 4.1 初始化和配置

```java
// 初始化MES集成器
public class MesIntegratorSetup {
    public void setupMesIntegration() {
        System.out.println("初始化MES集成器...");
        
        // 设置当前使用的MES类型
        MesIntegrator.setCurrentEngine(MesIntegrator.MesType.CUSTOM);
        
        // 设置当前指令处理器
        MesIntegrator.setCurrentProcessor(MesIntegrator.CommandType.CUSTOM);
        
        // 设置当前数据推送器
        MesIntegrator.setCurrentPusher(MesIntegrator.RealTimeTopic.CUSTOM);
        
        // 设置当前异常上报器
        MesIntegrator.setCurrentReporter(MesIntegrator.ExceptionType.CUSTOM);
        
        // 设置当前数据同步器
        MesIntegrator.setCurrentSynchronizer(MesIntegrator.DataPackageType.CUSTOM);
        
        System.out.println("MES集成器初始化完成");
        
        // 获取连接统计信息
        MesIntegrator.ConnectionStatistics connectionStats = MesIntegrator.getConnectionStatistics();
        System.out.println("连接状态: " + (connectionStats.isConnected() ? "已连接" : "未连接"));
        System.out.println("连接信息: " + connectionStats.getConnectionInfo());
    }
}
```

### 4.2 MES数据同步

```java
// 创建和同步数据包
public class DataSynchronizationExample {
    public void syncProductionData() {
        System.out.println("开始生产数据同步示例...");
        
        // 1. 创建生产数据包
        MesIntegrator.DataPackage productionData = MesIntegrator.createDataPackage(
            MesIntegrator.DataPackageType.PRODUCTION_DATA,
            "ProductionSystem",
            "MES"
        );
        
        if (productionData != null) {
            System.out.println("创建数据包成功: " + productionData.getPackageId());
            
            // 设置生产数据
            productionData.setBatchId("BATCH-20250821-001")
                         .setProductId("PRODUCT-XYZ-123")
                         .setData("lot_number", "LOT-20250821-001")
                         .setData("wafer_id", "WFR-001")
                         .setData("process_step", "Wire Bonding")
                         .setData("machine_id", "WB-001")
                         .setData("operator", "张三")
                         .setData("start_time", "2025-08-21T08:00:00")
                         .setData("end_time", "2025-08-21T08:30:00")
                         .setData("quantity_in", 1000)
                         .setData("quantity_out", 995)
                         .setData("yield", 99.5)
                         .setMetadata("line_id", "LINE-A")
                         .setMetadata("shift", "早班");
            
            System.out.println("数据包配置完成");
            System.out.println("  批次号: " + productionData.getBatchId());
            System.out.println("  产品ID: " + productionData.getProductId());
            System.out.println("  数据项数: " + productionData.getData().size());
            
            // 2. 同步数据到MES
            MesIntegrator.SyncResult syncResult = MesIntegrator.syncDataToMes(productionData);
            
            if (syncResult != null) {
                System.out.println("数据同步结果:");
                System.out.println("  结果ID: " + syncResult.getResultId());
                System.out.println("  数据包ID: " + syncResult.getPackageId());
                System.out.println("  同步成功: " + syncResult.isSuccess());
                System.out.println("  消息: " + syncResult.getMessage());
                System.out.println("  响应状态: " + syncResult.getResponseStatus().getDescription());
                System.out.println("  同步耗时: " + syncResult.getDuration() + "ms");
                
                if (!syncResult.isSuccess()) {
                    System.err.println("  错误信息: " + syncResult.getErrorMessage());
                }
            } else {
                System.err.println("数据同步失败，返回结果为空");
            }
        } else {
            System.err.println("数据包创建失败");
        }
    }
    
    public void syncQualityData() {
        System.out.println("\n开始质量数据同步示例...");
        
        // 创建质量数据包
        MesIntegrator.DataPackage qualityData = MesIntegrator.createDataPackage(
            MesIntegrator.DataPackageType.QUALITY_DATA,
            "QualitySystem",
            "MES"
        );
        
        if (qualityData != null) {
            // 设置质量数据
            qualityData.setBatchId("BATCH-20250821-001")
                      .setProductId("PRODUCT-XYZ-123")
                      .setData("test_item", "Wire Pull Strength")
                      .setData("spec_min", 5.0)
                      .setData("spec_max", 15.0)
                      .setData("actual_value", 8.5)
                      .setData("unit", "gf")
                      .setData("test_result", "PASS")
                      .setData("tester_id", "TST-001")
                      .setData("test_time", "2025-08-21T08:45:00")
                      .setMetadata("test_station", "WirePull-01")
                      .setMetadata("sample_size", 32);
            
            System.out.println("质量数据包配置完成");
            
            // 同步数据到MES
            MesIntegrator.SyncResult syncResult = MesIntegrator.syncDataToMes(qualityData);
            
            if (syncResult != null) {
                System.out.println("质量数据同步结果:");
                System.out.println("  同步成功: " + syncResult.isSuccess());
                System.out.println("  消息: " + syncResult.getMessage());
                System.out.println("  响应状态: " + syncResult.getResponseStatus().getDescription());
            }
        }
    }
    
    public void batchDataSync() {
        System.out.println("\n开始批量数据同步示例...");
        
        // 创建多个数据包
        List<MesIntegrator.DataPackage> dataPackages = new ArrayList<>();
        
        // 生产数据包1
        MesIntegrator.DataPackage prodData1 = MesIntegrator.createDataPackage(
            MesIntegrator.DataPackageType.PRODUCTION_DATA,
            "ProductionSystem",
            "MES"
        );
        prodData1.setBatchId("BATCH-20250821-001")
                .setProductId("PRODUCT-A")
                .setData("quantity", 1000);
        dataPackages.add(prodData1);
        
        // 生产数据包2
        MesIntegrator.DataPackage prodData2 = MesIntegrator.createDataPackage(
            MesIntegrator.DataPackageType.PRODUCTION_DATA,
            "ProductionSystem",
            "MES"
        );
        prodData2.setBatchId("BATCH-20250821-002")
                .setProductId("PRODUCT-B")
                .setData("quantity", 800);
        dataPackages.add(prodData2);
        
        // 质量数据包
        MesIntegrator.DataPackage qualityData = MesIntegrator.createDataPackage(
            MesIntegrator.DataPackageType.QUALITY_DATA,
            "QualitySystem",
            "MES"
        );
        qualityData.setBatchId("BATCH-20250821-001")
                  .setProductId("PRODUCT-A")
                  .setData("test_result", "PASS");
        dataPackages.add(qualityData);
        
        System.out.println("创建了 " + dataPackages.size() + " 个数据包");
        
        // 批量同步数据
        List<MesIntegrator.SyncResult> syncResults = MesIntegrator.syncBatchDataToMes(dataPackages);
        
        System.out.println("批量同步结果:");
        for (int i = 0; i < syncResults.size(); i++) {
            MesIntegrator.SyncResult result = syncResults.get(i);
            System.out.println("  数据包 " + (i+1) + ": " + 
                             (result.isSuccess() ? "成功" : "失败") + 
                             " - " + result.getMessage());
        }
    }
}
```

### 4.3 MES指令接收和处理

```java
// 处理MES指令
public class CommandProcessingExample {
    public void processMesCommands() {
        System.out.println("开始MES指令处理示例...");
        
        // 1. 处理启动工艺指令
        MesIntegrator.MesCommand startCommand = new MesIntegrator.MesCommand(
            MesIntegrator.CommandType.START_PROCESS,
            "WB-001",
            "MES"
        );
        
        startCommand.setWorkOrderId("WO-20250821-001")
                   .setBatchId("BATCH-20250821-001")
                   .setParameter("process_recipe", "WB-RECIPE-001")
                   .setParameter("target_temperature", 200)
                   .setParameter("bonding_force", 50)
                   .setParameter("ultrasonic_power", 75)
                   .setMetadata("priority", "HIGH")
                   .setMetadata("operator", "李四");
        
        System.out.println("创建启动工艺指令:");
        System.out.println("  指令ID: " + startCommand.getCommandId());
        System.out.println("  指令类型: " + startCommand.getCommandType().getChineseName());
        System.out.println("  目标设备: " + startCommand.getTargetEquipment());
        System.out.println("  工单号: " + startCommand.getWorkOrderId());
        System.out.println("  参数数量: " + startCommand.getParameters().size());
        
        // 处理指令
        MesIntegrator.CommandResponse startResponse = MesIntegrator.processMesCommand(startCommand);
        
        if (startResponse != null) {
            System.out.println("启动工艺指令处理结果:");
            System.out.println("  响应ID: " + startResponse.getResponseId());
            System.out.println("  指令ID: " + startResponse.getCommandId());
            System.out.println("  处理状态: " + startResponse.getStatus().getDescription());
            System.out.println("  响应消息: " + startResponse.getMessage());
            System.out.println("  处理耗时: " + startResponse.getProcessingTime() + "ms");
            
            if (!startResponse.getResponseData().isEmpty()) {
                System.out.println("  响应数据:");
                startResponse.getResponseData().forEach((key, value) -> 
                    System.out.println("    " + key + ": " + value));
            }
        }
        
        // 2. 处理调整参数指令
        MesIntegrator.MesCommand adjustCommand = new MesIntegrator.MesCommand(
            MesIntegrator.CommandType.ADJUST_PARAMETERS,
            "WB-001",
            "MES"
        );
        
        adjustCommand.setParameter("bonding_force", 55)
                    .setParameter("ultrasonic_power", 80)
                    .setParameter("bonding_time", 30)
                    .setMetadata("reason", "质量优化")
                    .setMetadata("approved_by", "质量经理");
        
        System.out.println("\n创建参数调整指令:");
        
        MesIntegrator.CommandResponse adjustResponse = MesIntegrator.processMesCommand(adjustCommand);
        
        if (adjustResponse != null) {
            System.out.println("参数调整指令处理结果:");
            System.out.println("  处理状态: " + adjustResponse.getStatus().getDescription());
            System.out.println("  响应消息: " + adjustResponse.getMessage());
        }
        
        // 3. 处理停止工艺指令
        MesIntegrator.MesCommand stopCommand = new MesIntegrator.MesCommand(
            MesIntegrator.CommandType.STOP_PROCESS,
            "WB-001",
            "MES"
        );
        
        stopCommand.setWorkOrderId("WO-20250821-001")
                  .setMetadata("reason", "计划完成")
                  .setMetadata("operator", "王五");
        
        System.out.println("\n创建停止工艺指令:");
        
        MesIntegrator.CommandResponse stopResponse = MesIntegrator.processMesCommand(stopCommand);
        
        if (stopResponse != null) {
            System.out.println("停止工艺指令处理结果:");
            System.out.println("  处理状态: " + stopResponse.getStatus().getDescription());
            System.out.println("  响应消息: " + stopResponse.getMessage());
        }
    }
}
```

### 4.4 实时数据推送

```java
// 实时数据推送
public class RealTimeDataPushExample {
    public void pushRealTimeData() {
        System.out.println("开始实时数据推送示例...");
        
        // 1. 推送生产状态数据
        Map<String, Object> productionStatus = new HashMap<>();
        productionStatus.put("machine_id", "WB-001");
        productionStatus.put("status", "RUNNING");
        productionStatus.put("current_lot", "LOT-20250821-001");
        productionStatus.put("processed_count", 150);
        productionStatus.put("remaining_count", 850);
        productionStatus.put("timestamp", "2025-08-21T09:00:00");
        
        boolean pushed1 = MesIntegrator.pushRealTimeData(
            MesIntegrator.RealTimeTopic.PRODUCTION_STATUS.name(), 
            productionStatus
        );
        
        System.out.println("生产状态数据推送: " + (pushed1 ? "成功" : "失败"));
        
        // 2. 推送质量指标数据
        Map<String, Object> qualityMetrics = new HashMap<>();
        qualityMetrics.put("test_item", "Wire Pull Strength");
        qualityMetrics.put("actual_value", 9.2);
        qualityMetrics.put("spec_min", 5.0);
        qualityMetrics.put("spec_max", 15.0);
        qualityMetrics.put("cpk", 1.33);
        qualityMetrics.put("timestamp", "2025-08-21T09:05:00");
        
        boolean pushed2 = MesIntegrator.pushRealTimeData(
            MesIntegrator.RealTimeTopic.QUALITY_METRICS.name(), 
            qualityMetrics
        );
        
        System.out.println("质量指标数据推送: " + (pushed2 ? "成功" : "失败"));
        
        // 3. 推送设备状态数据
        Map<String, Object> equipmentStatus = new HashMap<>();
        equipmentStatus.put("equipment_id", "WB-001");
        equipmentStatus.put("status", "RUNNING");
        equipmentStatus.put("temperature", 198.5);
        equipmentStatus.put("humidity", 45.2);
        equipmentStatus.put("pressure", 75.8);
        equipmentStatus.put("alarm_status", "NORMAL");
        equipmentStatus.put("timestamp", "2025-08-21T09:10:00");
        
        boolean pushed3 = MesIntegrator.pushRealTimeData(
            MesIntegrator.RealTimeTopic.EQUIPMENT_STATUS.name(), 
            equipmentStatus
        );
        
        System.out.println("设备状态数据推送: " + (pushed3 ? "成功" : "失败"));
        
        // 4. 推送自定义数据
        Map<String, Object> customData = new HashMap<>();
        customData.put("event_type", "MAINTENANCE_COMPLETED");
        customData.put("equipment_id", "WB-001");
        customData.put("technician", "赵六");
        customData.put("duration_minutes", 120);
        customData.put("next_maintenance_due", "2025-09-21");
        
        boolean pushed4 = MesIntegrator.pushRealTimeData("CUSTOM_MAINTENANCE", customData);
        
        System.out.println("自定义数据推送: " + (pushed4 ? "成功" : "失败"));
    }
}
```

### 4.5 异常数据上报

```java
// 异常数据上报
public class ExceptionReportingExample {
    public void reportExceptions() {
        System.out.println("开始异常数据上报示例...");
        
        // 1. 上报通信错误
        MesIntegrator.ExceptionData commException = new MesIntegrator.ExceptionData(
            MesIntegrator.ExceptionType.COMMUNICATION_ERROR,
            "ProductionSystem",
            "MES",
            "与MES系统通信超时"
        );
        
        commException.setContextData("endpoint", "http://mes-server:8080/api")
                    .setContextData("timeout_seconds", 30)
                    .setContextData("retry_count", 3)
                    .setSeverity("HIGH")
                    .setAssignedTo("系统管理员")
                    .setMetadata("module", "data_sync")
                    .setMetadata("function", "syncDataToMes");
        
        System.out.println("创建通信异常数据:");
        System.out.println("  异常ID: " + commException.getExceptionId());
        System.out.println("  异常类型: " + commException.getExceptionType().getChineseName());
        System.out.println("  错误信息: " + commException.getErrorMessage());
        System.out.println("  严重程度: " + commException.getSeverity());
        System.out.println("  上下文数据项数: " + commException.getContextData().size());
        
        boolean reported1 = MesIntegrator.reportExceptionData(commException);
        System.out.println("通信异常上报: " + (reported1 ? "成功" : "失败"));
        
        // 2. 上报数据格式错误
        MesIntegrator.ExceptionData formatException = new MesIntegrator.ExceptionData(
            MesIntegrator.ExceptionType.DATA_FORMAT_ERROR,
            "QualitySystem",
            "MES",
            "质量数据格式不正确"
        );
        
        formatException.setContextData("field_name", "test_result")
                      .setContextData("expected_format", "PASS|FAIL|NC")
                      .setContextData("actual_value", "PASSED")
                      .setSeverity("MEDIUM")
                      .setMetadata("data_package_id", "DP-20250821-001")
                      .setMetadata("batch_id", "BATCH-20250821-001");
        
        System.out.println("\n创建数据格式异常数据:");
        
        boolean reported2 = MesIntegrator.reportExceptionData(formatException);
        System.out.println("数据格式异常上报: " + (reported2 ? "成功" : "失败"));
        
        // 3. 上报超时错误
        MesIntegrator.ExceptionData timeoutException = new MesIntegrator.ExceptionData(
            MesIntegrator.ExceptionType.TIMEOUT_ERROR,
            "EquipmentSystem",
            "MES",
            "设备状态查询超时"
        );
        
        timeoutException.setContextData("equipment_id", "WB-001")
                       .setContextData("timeout_seconds", 10)
                       .setContextData("last_success_time", "2025-08-21T08:55:00")
                       .setSeverity("MEDIUM")
                       .setAssignedTo("设备维护组")
                       .setMetadata("polling_interval", 5)
                       .setMetadata("retry_attempts", 2);
        
        System.out.println("\n创建超时异常数据:");
        
        boolean reported3 = MesIntegrator.reportExceptionData(timeoutException);
        System.out.println("超时异常上报: " + (reported3 ? "成功" : "失败"));
        
        // 4. 上报业务规则违反
        MesIntegrator.ExceptionData businessException = new MesIntegrator.ExceptionData(
            MesIntegrator.ExceptionType.BUSINESS_RULE_VIOLATION,
            "ProductionSystem",
            "MES",
            "生产数量超过工单计划"
        );
        
        businessException.setContextData("work_order", "WO-20250821-001")
                        .setContextData("planned_quantity", 1000)
                        .setContextData("actual_quantity", 1050)
                        .setContextData("overage", 50)
                        .setSeverity("HIGH")
                        .setMetadata("process_step", "Wire Bonding")
                        .setMetadata("machine_id", "WB-001");
        
        System.out.println("\n创建业务规则异常数据:");
        
        boolean reported4 = MesIntegrator.reportExceptionData(businessException);
        System.out.println("业务规则异常上报: " + (reported4 ? "成功" : "失败"));
    }
}
```

## 5. 高级使用示例

### 5.1 完整的MES集成流程

```java
public class CompleteMesIntegrationProcess {
    public void executeCompleteIntegrationProcess() {
        try {
            System.out.println("=== 开始完整的MES集成流程 ===");
            
            // 步骤1: 初始化和配置
            System.out.println("\n步骤1: 初始化和配置MES集成器");
            initializeMesIntegrator();
            
            // 步骤2: 数据同步
            System.out.println("\n步骤2: 执行数据同步");
            performDataSynchronization();
            
            // 步骤3: 指令处理
            System.out.println("\n步骤3: 处理MES指令");
            processMesCommands();
            
            // 步骤4: 实时数据推送
            System.out.println("\n步骤4: 推送实时数据");
            pushRealTimeData();
            
            // 步骤5: 异常处理
            System.out.println("\n步骤5: 处理异常情况");
            handleExceptions();
            
            // 步骤6: 状态监控
            System.out.println("\n步骤6: 监控系统状态");
            monitorSystemStatus();
            
            System.out.println("\n=== MES集成流程完成 ===");
            
        } catch (Exception e) {
            System.err.println("MES集成流程执行过程中发生错误: " + e.getMessage());
            e.printStackTrace();
        }
    }
    
    private void initializeMesIntegrator() {
        System.out.println("初始化MES集成器配置...");
        
        // 设置当前组件（实际应用中应根据具体MES系统类型设置）
        MesIntegrator.setCurrentEngine(MesIntegrator.MesType.CUSTOM);
        MesIntegrator.setCurrentProcessor(MesIntegrator.CommandType.CUSTOM);
        MesIntegrator.setCurrentPusher(MesIntegrator.RealTimeTopic.CUSTOM);
        MesIntegrator.setCurrentReporter(MesIntegrator.ExceptionType.CUSTOM);
        MesIntegrator.setCurrentSynchronizer(MesIntegrator.DataPackageType.CUSTOM);
        
        // 检查连接状态
        MesIntegrator.ConnectionStatistics connectionStats = MesIntegrator.getConnectionStatistics();
        System.out.println("连接状态: " + (connectionStats.isConnected() ? "已连接" : "未连接"));
        System.out.println("连接信息: " + connectionStats.getConnectionInfo());
        
        // 获取缓存统计信息
        MesIntegrator.CacheStatistics cacheStats = MesIntegrator.getCacheStatistics();
        System.out.println("缓存统计:");
        System.out.println("  数据包缓存: " + cacheStats.getPackageCacheSize());
        System.out.println("  结果缓存: " + cacheStats.getResultCacheSize());
        System.out.println("  消息队列: " + cacheStats.getMessageQueueSize());
    }
    
    private void performDataSynchronization() {
        System.out.println("执行数据同步...");
        
        // 创建生产数据包
        MesIntegrator.DataPackage productionData = MesIntegrator.createDataPackage(
            MesIntegrator.DataPackageType.PRODUCTION_DATA,
            "ProductionSystem",
            "MES"
        );
        
        productionData.setBatchId("BATCH-20250821-001")
                     .setProductId("PRODUCT-XYZ-123")
                     .setData("process_step", "Wire Bonding")
                     .setData("machine_id", "WB-001")
                     .setData("operator", "张三")
                     .setData("quantity_in", 1000)
                     .setData("quantity_out", 995)
                     .setData("yield", 99.5)
                     .setMetadata("line_id", "LINE-A");
        
        // 同步生产数据
        MesIntegrator.SyncResult prodSyncResult = MesIntegrator.syncDataToMes(productionData);
        System.out.println("生产数据同步: " + (prodSyncResult.isSuccess() ? "成功" : "失败"));
        
        // 创建质量数据包
        MesIntegrator.DataPackage qualityData = MesIntegrator.createDataPackage(
            MesIntegrator.DataPackageType.QUALITY_DATA,
            "QualitySystem",
            "MES"
        );
        
        qualityData.setBatchId("BATCH-20250821-001")
                  .setProductId("PRODUCT-XYZ-123")
                  .setData("test_item", "Wire Pull Strength")
                  .setData("spec_min", 5.0)
                  .setData("spec_max", 15.0)
                  .setData("actual_value", 8.5)
                  .setData("test_result", "PASS")
                  .setMetadata("test_station", "WirePull-01");
        
        // 同步质量数据
        MesIntegrator.SyncResult qualitySyncResult = MesIntegrator.syncDataToMes(qualityData);
        System.out.println("质量数据同步: " + (qualitySyncResult.isSuccess() ? "成功" : "失败"));
        
        // 创建设备数据包
        MesIntegrator.DataPackage equipmentData = MesIntegrator.createDataPackage(
            MesIntegrator.DataPackageType.EQUIPMENT_DATA,
            "EquipmentSystem",
            "MES"
        );
        
        equipmentData.setBatchId("BATCH-20250821-001")
                    .setData("equipment_id", "WB-001")
                    .setData("temperature", 200.5)
                    .setData("pressure", 75.2)
                    .setData("status", "RUNNING")
                    .setMetadata("reading_time", "2025-08-21T10:00:00");
        
        // 同步设备数据
        MesIntegrator.SyncResult equipSyncResult = MesIntegrator.syncDataToMes(equipmentData);
        System.out.println("设备数据同步: " + (equipSyncResult.isSuccess() ? "成功" : "失败"));
    }
    
    private void processMesCommands() {
        System.out.println("处理MES指令...");
        
        // 处理启动工艺指令
        MesIntegrator.MesCommand startCommand = new MesIntegrator.MesCommand(
            MesIntegrator.CommandType.START_PROCESS,
            "WB-001",
            "MES"
        );
        
        startCommand.setWorkOrderId("WO-20250821-001")
                   .setParameter("process_recipe", "WB-RECIPE-001")
                   .setParameter("target_temperature", 200);
        
        MesIntegrator.CommandResponse startResponse = MesIntegrator.processMesCommand(startCommand);
        System.out.println("启动工艺指令处理: " + startResponse.getStatus().getDescription());
        
        // 处理参数调整指令
        MesIntegrator.MesCommand adjustCommand = new MesIntegrator.MesCommand(
            MesIntegrator.CommandType.ADJUST_PARAMETERS,
            "WB-001",
            "MES"
        );
        
        adjustCommand.setParameter("bonding_force", 55)
                    .setParameter("ultrasonic_power", 80);
        
        MesIntegrator.CommandResponse adjustResponse = MesIntegrator.processMesCommand(adjustCommand);
        System.out.println("参数调整指令处理: " + adjustResponse.getStatus().getDescription());
        
        // 处理停止工艺指令
        MesIntegrator.MesCommand stopCommand = new MesIntegrator.MesCommand(
            MesIntegrator.CommandType.STOP_PROCESS,
            "WB-001",
            "MES"
        );
        
        stopCommand.setWorkOrderId("WO-20250821-001");
        
        MesIntegrator.CommandResponse stopResponse = MesIntegrator.processMesCommand(stopCommand);
        System.out.println("停止工艺指令处理: " + stopResponse.getStatus().getDescription());
    }
    
    private void pushRealTimeData() {
        System.out.println("推送实时数据...");
        
        // 推送生产状态
        Map<String, Object> productionStatus = new HashMap<>();
        productionStatus.put("machine_id", "WB-001");
        productionStatus.put("status", "RUNNING");
        productionStatus.put("current_lot", "LOT-20250821-001");
        productionStatus.put("processed_count", 200);
        
        boolean pushed1 = MesIntegrator.pushRealTimeData(
            MesIntegrator.RealTimeTopic.PRODUCTION_STATUS.name(), 
            productionStatus
        );
        System.out.println("生产状态推送: " + (pushed1 ? "成功" : "失败"));
        
        // 推送质量指标
        Map<String, Object> qualityMetrics = new HashMap<>();
        qualityMetrics.put("test_item", "Wire Pull Strength");
        qualityMetrics.put("actual_value", 9.1);
        qualityMetrics.put("cpk", 1.42);
        
        boolean pushed2 = MesIntegrator.pushRealTimeData(
            MesIntegrator.RealTimeTopic.QUALITY_METRICS.name(), 
            qualityMetrics
        );
        System.out.println("质量指标推送: " + (pushed2 ? "成功" : "失败"));
        
        // 推送设备状态
        Map<String, Object> equipmentStatus = new HashMap<>();
        equipmentStatus.put("equipment_id", "WB-001");
        equipmentStatus.put("status", "RUNNING");
        equipmentStatus.put("temperature", 199.8);
        equipmentStatus.put("alarm_status", "NORMAL");
        
        boolean pushed3 = MesIntegrator.pushRealTimeData(
            MesIntegrator.RealTimeTopic.EQUIPMENT_STATUS.name(), 
            equipmentStatus
        );
        System.out.println("设备状态推送: " + (pushed3 ? "成功" : "失败"));
    }
    
    private void handleExceptions() {
        System.out.println("处理异常情况...");
        
        // 上报通信异常
        MesIntegrator.ExceptionData commException = new MesIntegrator.ExceptionData(
            MesIntegrator.ExceptionType.COMMUNICATION_ERROR,
            "ProductionSystem",
            "MES",
            "与MES系统通信超时"
        );
        
        commException.setContextData("endpoint", "http://mes-server:8080/api")
                    .setSeverity("HIGH");
        
        boolean reported1 = MesIntegrator.reportExceptionData(commException);
        System.out.println("通信异常上报: " + (reported1 ? "成功" : "失败"));
        
        // 上报数据格式异常
        MesIntegrator.ExceptionData formatException = new MesIntegrator.ExceptionData(
            MesIntegrator.ExceptionType.DATA_FORMAT_ERROR,
            "QualitySystem",
            "MES",
            "质量数据格式不正确"
        );
        
        formatException.setContextData("field_name", "test_result")
                      .setSeverity("MEDIUM");
        
        boolean reported2 = MesIntegrator.reportExceptionData(formatException);
        System.out.println("数据格式异常上报: " + (reported2 ? "成功" : "失败"));
    }
    
    private void monitorSystemStatus() {
        System.out.println("监控系统状态...");
        
        // 获取缓存统计信息
        MesIntegrator.CacheStatistics cacheStats = MesIntegrator.getCacheStatistics();
        System.out.println("缓存状态:");
        System.out.println("  数据包缓存数量: " + cacheStats.getPackageCacheSize());
        System.out.println("  结果缓存数量: " + cacheStats.getResultCacheSize());
        System.out.println("  消息队列大小: " + cacheStats.getMessageQueueSize());
        
        // 获取连接统计信息
        MesIntegrator.ConnectionStatistics connStats = MesIntegrator.getConnectionStatistics();
        System.out.println("连接状态:");
        System.out.println("  是否连接: " + (connStats.isConnected() ? "是" : "否"));
        System.out.println("  连接信息: " + connStats.getConnectionInfo());
        
        // 检查数据包状态
        System.out.println("数据包处理统计:");
        // 这里可以查询特定数据包的状态
        // MesIntegrator.SyncStatus status = MesIntegrator.getSyncStatus(packageId);
    }
}
```

### 5.2 MES集成监控和分析

```java
public class MesIntegrationMonitoring {
    public void monitorAndAnalyzeIntegration() {
        System.out.println("=== MES集成监控和分析 ===");
        
        // 监控缓存状态
        monitorCacheStatus();
        
        // 监控连接状态
        monitorConnectionStatus();
        
        // 分析同步性能
        analyzeSyncPerformance();
        
        // 检查异常情况
        checkExceptionStatus();
        
        System.out.println("=== 监控和分析完成 ===");
    }
    
    private void monitorCacheStatus() {
        System.out.println("\n缓存状态监控:");
        
        MesIntegrator.CacheStatistics cacheStats = MesIntegrator.getCacheStatistics();
        
        System.out.println("缓存统计信息:");
        System.out.println("  数据包缓存数量: " + cacheStats.getPackageCacheSize());
        System.out.println("  结果缓存数量: " + cacheStats.getResultCacheSize());
        System.out.println("  消息队列大小: " + cacheStats.getMessageQueueSize());
        System.out.println("  缓存超时时间: " + cacheStats.getCacheTimeout() + "ms");
        
        // 评估缓存健康状况
        if (cacheStats.getPackageCacheSize() > 1000) {
            System.out.println("  警告: 数据包缓存较大，可能需要清理");
        }
        
        if (cacheStats.getMessageQueueSize() > 5000) {
            System.out.println("  警告: 消息队列积压严重，处理速度可能不足");
        }
    }
    
    private void monitorConnectionStatus() {
        System.out.println("\n连接状态监控:");
        
        MesIntegrator.ConnectionStatistics connStats = MesIntegrator.getConnectionStatistics();
        
        System.out.println("连接统计信息:");
        System.out.println("  是否连接: " + (connStats.isConnected() ? "是" : "否"));
        System.out.println("  连接信息: " + connStats.getConnectionInfo());
        System.out.println("  连接超时: " + connStats.getConnectionTimeout() + "ms");
        
        if (!connStats.isConnected()) {
            System.out.println("  警告: MES连接已断开，需要重新连接");
        }
    }
    
    private void analyzeSyncPerformance() {
        System.out.println("\n同步性能分析:");
        
        // 模拟性能分析（实际应用中可以从日志或监控系统获取数据）
        System.out.println("同步性能指标:");
        System.out.println("  平均同步耗时: 150ms");
        System.out.println("  同步成功率: 98.5%");
        System.out.println("  最大并发同步数: 50");
        System.out.println("  队列等待时间: 5ms");
        
        // 性能建议
        System.out.println("性能优化建议:");
        System.out.println("  1. 对于大批量数据，建议使用批量同步接口");
        System.out.println("  2. 定期清理过期缓存数据");
        System.out.println("  3. 监控网络延迟，优化通信参数");
    }
    
    private void checkExceptionStatus() {
        System.out.println("\n异常状态检查:");
        
        // 模拟异常检查（实际应用中应该查询异常日志或数据库）
        System.out.println("异常统计:");
        System.out.println("  今日异常总数: 3");
        System.out.println("  未处理异常: 0");
        System.out.println("  最常见异常类型: 通信错误");
        System.out.println("  平均异常处理时间: 2.5分钟");
        
        System.out.println("异常处理建议:");
        System.out.println("  1. 建立异常自动恢复机制");
        System.out.println("  2. 设置异常阈值告警");
        System.out.println("  3. 定期分析异常模式，优化系统稳定性");
    }
    
    public void generateIntegrationReport() {
        System.out.println("\n=== 生成MES集成报告 ===");
        
        System.out.println("MES集成系统报告");
        System.out.println("========================");
        System.out.println("报告生成时间: " + java.time.LocalDateTime.now());
        System.out.println();
        
        // 系统配置信息
        System.out.println("1. 系统配置信息");
        System.out.println("   当前MES类型: " + MesIntegrator.MesType.CUSTOM.getChineseName());
        System.out.println("   支持的数据包类型: " + MesIntegrator.DataPackageType.values().length + " 种");
        System.out.println("   支持的指令类型: " + MesIntegrator.CommandType.values().length + " 种");
        System.out.println("   支持的异常类型: " + MesIntegrator.ExceptionType.values().length + " 种");
        System.out.println();
        
        // 运行状态信息
        System.out.println("2. 运行状态信息");
        MesIntegrator.CacheStatistics cacheStats = MesIntegrator.getCacheStatistics();
        MesIntegrator.ConnectionStatistics connStats = MesIntegrator.getConnectionStatistics();
        
        System.out.println("   缓存状态:");
        System.out.println("     数据包缓存: " + cacheStats.getPackageCacheSize() + " 个");
        System.out.println("     结果缓存: " + cacheStats.getResultCacheSize() + " 个");
        System.out.println("     消息队列: " + cacheStats.getMessageQueueSize() + " 条");
        System.out.println("   连接状态:");
        System.out.println("     是否连接: " + (connStats.isConnected() ? "是" : "否"));
        System.out.println("     连接信息: " + connStats.getConnectionInfo());
        System.out.println();
        
        // 性能指标
        System.out.println("3. 性能指标");
        System.out.println("   数据同步性能:");
        System.out.println("     平均耗时: 150ms");
        System.out.println("     成功率: 98.5%");
        System.out.println("     最大并发: 50");
        System.out.println("   指令处理性能:");
        System.out.println("     平均耗时: 85ms");
        System.out.println("     成功率: 99.2%");
        System.out.println("   实时数据推送:");
        System.out.println("     平均延迟: 5ms");
        System.out.println("     成功率: 99.8%");
        System.out.println();
        
        // 异常统计
        System.out.println("4. 异常统计");
        System.out.println("   今日异常: 3 次");
        System.out.println("     通信错误: 1 次");
        System.out.println("     数据格式错误: 1 次");
        System.out.println("     超时错误: 1 次");
        System.out.println("   异常处理:");
        System.out.println("     已处理: 3 次");
        System.out.println("     未处理: 0 次");
        System.out.println();
        
        // 建议和改进
        System.out.println("5. 建议和改进");
        System.out.println("   性能优化:");
        System.out.println("     - 考虑增加批量处理以提高吞吐量");
        System.out.println("     - 优化网络通信参数");
        System.out.println("   稳定性提升:");
        System.out.println("     - 增强异常自动恢复机制");
        System.out.println("     - 完善监控告警体系");
        System.out.println("   功能扩展:");
        System.out.println("     - 增加更多MES系统类型支持");
        System.out.println("     - 扩展数据包类型和指令类型");
        
        System.out.println("========================");
        System.out.println("报告生成完成");
    }
}
```

## 6. 配置参数详解

### 6.1 系统级配置参数

```java
public class MesIntegratorConfig {
    // 缓存超时时间（毫秒）
    public static final long CACHE_TIMEOUT = 30 * 60 * 1000; // 30分钟
    
    // 最大重试次数
    public static final int MAX_RETRY_ATTEMPTS = 3;
    
    // 重试延迟（毫秒）
    public static final long RETRY_DELAY = 1000; // 1秒
    
    // 批量处理大小
    public static final int BATCH_SIZE = 100;
    
    // 数据同步间隔（毫秒）
    public static final long SYNC_INTERVAL = 5 * 60 * 1000; // 5分钟
    
    // 消息队列大小
    public static final int MESSAGE_QUEUE_SIZE = 10000;
    
    // 连接超时时间（毫秒）
    public static final long CONNECTION_TIMEOUT = 30000; // 30秒
}
```

### 6.2 组件配置

```java
// 配置不同的MES集成组件
public class ComponentConfiguration {
    public void configureComponents() {
        // 配置西门子MES集成器
        // MesIntegrator.registerEngine(new SiemensMesIntegratorEngine());
        // MesIntegrator.setCurrentEngine(MesIntegrator.MesType.SIEMENS_SIMATIC_IT);
        
        // 配置罗克韦尔MES指令处理器
        // MesIntegrator.registerProcessor(new RockwellCommandProcessor());
        // MesIntegrator.setCurrentProcessor(MesIntegrator.CommandType.CUSTOM);
        
        // 配置霍尼韦尔实时数据推送器
        // MesIntegrator.registerPusher(new HoneywellDataPusher());
        // MesIntegrator.setCurrentPusher(MesIntegrator.RealTimeTopic.CUSTOM);
        
        // 配置康思尔异常上报器
        // MesIntegrator.registerReporter(new CamstarExceptionReporter());
        // MesIntegrator.setCurrentReporter(MesIntegrator.ExceptionType.CUSTOM);
        
        System.out.println("组件配置完成");
    }
}
```

## 7. 错误处理

### 7.1 异常处理示例

```java
public class MesIntegratorErrorHandler {
    public void handleIntegrationErrors() {
        System.out.println("MES集成错误处理示例");
        
        try {
            // 尝试同步数据
            MesIntegrator.DataPackage dataPackage = MesIntegrator.createDataPackage(
                MesIntegrator.DataPackageType.PRODUCTION_DATA,
                "ProductionSystem",
                "MES"
            );
            
            MesIntegrator.SyncResult result = MesIntegrator.syncDataToMes(dataPackage);
            
            if (result != null) {
                if (result.isSuccess()) {
                    System.out.println("数据同步成功");
                } else {
                    System.err.println("数据同步失败: " + result.getMessage());
                    
                    // 根据错误类型采取不同处理措施
                    switch (result.getResponseStatus()) {
                        case FAILURE:
                            System.err.println("同步完全失败，需要重试或人工干预");
                            break;
                        case TIMEOUT:
                            System.err.println("同步超时，建议稍后重试");
                            break;
                        case REJECTED:
                            System.err.println("MES系统拒绝接收数据，检查数据格式");
                            break;
                        default:
                            System.err.println("未知错误状态: " + result.getResponseStatus());
                    }
                }
            } else {
                System.err.println("同步结果为空，可能是系统内部错误");
            }
            
        } catch (Exception e) {
            System.err.println("数据同步过程中发生异常: " + e.getMessage());
            e.printStackTrace();
            
            // 记录异常并上报
            MesIntegrator.ExceptionData exceptionData = new MesIntegrator.ExceptionData(
                MesIntegrator.ExceptionType.COMMUNICATION_ERROR,
                "LocalSystem",
                "MES",
                "数据同步异常: " + e.getMessage()
            );
            
            boolean reported = MesIntegrator.reportExceptionData(exceptionData);
            System.out.println("异常上报: " + (reported ? "成功" : "失败"));
        }
    }
    
    public boolean safeDataSync(MesIntegrator.DataPackage dataPackage) {
        if (dataPackage == null) {
            System.err.println("数据包不能为空");
            return false;
        }
        
        int maxRetries = 3;
        int retryCount = 0;
        
        while (retryCount < maxRetries) {
            try {
                MesIntegrator.SyncResult result = MesIntegrator.syncDataToMes(dataPackage);
                
                if (result != null && result.isSuccess()) {
                    System.out.println("数据同步成功");
                    return true;
                } else if (result != null) {
                    System.err.println("第" + (retryCount + 1) + "次同步失败: " + result.getMessage());
                    
                    // 如果是不可重试的错误，直接返回
                    if (result.getResponseStatus() == MesIntegrator.ResponseStatus.REJECTED) {
                        System.err.println("数据被MES拒绝，不进行重试");
                        return false;
                    }
                } else {
                    System.err.println("第" + (retryCount + 1) + "次同步返回空结果");
                }
                
            } catch (Exception e) {
                System.err.println("第" + (retryCount + 1) + "次同步异常: " + e.getMessage());
            }
            
            retryCount++;
            
            // 重试前等待
            if (retryCount < maxRetries) {
                try {
                    Thread.sleep(1000 * retryCount); // 递增延迟
                } catch (InterruptedException e) {
                    Thread.currentThread().interrupt();
                    break;
                }
            }
        }
        
        System.err.println("数据同步最终失败，已重试 " + maxRetries + " 次");
        return false;
    }
}
```

## 8. 最佳实践

### 8.1 数据同步最佳实践

```java
public class DataSyncBestPractices {
    public void demonstrateBestPractices() {
        System.out.println("MES数据同步最佳实践演示");
        
        // 1. 数据验证
        System.out.println("1. 数据验证");
        MesIntegrator.DataPackage dataPackage = createValidatedDataPackage();
        if (dataPackage == null) {
            System.err.println("数据包验证失败");
            return;
        }
        
        // 2. 批量处理
        System.out.println("2. 批量处理");
        List<MesIntegrator.DataPackage> batchPackages = createBatchDataPackages();
        if (batchPackages.size() > 50) {
            // 分批处理大量数据
            processInBatches(batchPackages);
        } else {
            // 直接处理小批量数据
            processBatchData(batchPackages);
        }
        
        // 3. 异步处理
        System.out.println("3. 异步处理");
        processDataAsynchronously(dataPackage);
        
        // 4. 错误处理和重试
        System.out.println("4. 错误处理和重试");
        handleWithRetry(dataPackage);
    }
    
    private MesIntegrator.DataPackage createValidatedDataPackage() {
        // 创建数据包
        MesIntegrator.DataPackage dataPackage = MesIntegrator.createDataPackage(
            MesIntegrator.DataPackageType.PRODUCTION_DATA,
            "ProductionSystem",
            "MES"
        );
        
        if (dataPackage == null) {
            return null;
        }
        
        // 验证必需字段
        String batchId = "BATCH-20250821-001";
        String productId = "PRODUCT-XYZ-123";
        
        if (batchId == null || batchId.isEmpty()) {
            System.err.println("批次号不能为空");
            return null;
        }
        
        if (productId == null || productId.isEmpty()) {
            System.err.println("产品ID不能为空");
            return null;
        }
        
        // 设置数据
        dataPackage.setBatchId(batchId)
                  .setProductId(productId)
                  .setData("quantity", 1000)
                  .setData("process_step", "Wire Bonding");
        
        System.out.println("数据包验证通过");
        return dataPackage;
    }
    
    private List<MesIntegrator.DataPackage> createBatchDataPackages() {
        List<MesIntegrator.DataPackage> packages = new ArrayList<>();
        
        // 创建多个数据包
        for (int i = 1; i <= 10; i++) {
            MesIntegrator.DataPackage pkg = MesIntegrator.createDataPackage(
                MesIntegrator.DataPackageType.PRODUCTION_DATA,
                "ProductionSystem",
                "MES"
            );
            
            if (pkg != null) {
                pkg.setBatchId("BATCH-20250821-" + String.format("%03d", i))
                   .setProductId("PRODUCT-XYZ-123")
                   .setData("quantity", 1000 + i * 10);
                
                packages.add(pkg);
            }
        }
        
        return packages;
    }
    
    private void processInBatches(List<MesIntegrator.DataPackage> packages) {
        int batchSize = 50;
        
        for (int i = 0; i < packages.size(); i += batchSize) {
            int endIndex = Math.min(i + batchSize, packages.size());
            List<MesIntegrator.DataPackage> batch = packages.subList(i, endIndex);
            
            System.out.println("处理批次: " + (i/batchSize + 1) + ", 大小: " + batch.size());
            processBatchData(batch);
        }
    }
    
    private void processBatchData(List<MesIntegrator.DataPackage> packages) {
        List<MesIntegrator.SyncResult> results = MesIntegrator.syncBatchDataToMes(packages);
        
        int successCount = 0;
        for (MesIntegrator.SyncResult result : results) {
            if (result.isSuccess()) {
                successCount++;
            } else {
                System.err.println("同步失败: " + result.getMessage());
            }
        }
        
        System.out.println("批量处理完成，成功: " + successCount + "/" + results.size());
    }
    
    private void processDataAsynchronously(MesIntegrator.DataPackage dataPackage) {
        // 使用异步方式处理数据同步
        CompletableFuture<MesIntegrator.SyncResult> future = CompletableFuture.supplyAsync(() -> {
            return MesIntegrator.syncDataToMes(dataPackage);
        });
        
        // 设置超时和回调
        future.thenAccept(result -> {
            if (result != null && result.isSuccess()) {
                System.out.println("异步数据同步成功");
            } else {
                System.err.println("异步数据同步失败");
            }
        }).exceptionally(throwable -> {
            System.err.println("异步数据同步异常: " + throwable.getMessage());
            return null;
        });
        
        System.out.println("异步数据同步已提交");
    }
    
    private void handleWithRetry(MesIntegrator.DataPackage dataPackage) {
        int maxRetries = 3;
        int retryDelay = 1000; // 1秒
        
        for (int i = 0; i < maxRetries; i++) {
            try {
                MesIntegrator.SyncResult result = MesIntegrator.syncDataToMes(dataPackage);
                
                if (result != null && result.isSuccess()) {
                    System.out.println("数据同步成功");
                    return;
                } else if (result != null) {
                    System.err.println("第" + (i + 1) + "次同步失败: " + result.getMessage());
                }
                
            } catch (Exception e) {
                System.err.println("第" + (i + 1) + "次同步异常: " + e.getMessage());
            }
            
            // 重试前等待
            if (i < maxRetries - 1) {
                try {
                    Thread.sleep(retryDelay * (i + 1));
                } catch (InterruptedException e) {
                    Thread.currentThread().interrupt();
                    break;
                }
            }
        }
        
        System.err.println("数据同步最终失败");
    }
}
```

### 8.2 性能优化实践

```java
public class PerformanceOptimization {
    private final Map<String, MesIntegrator.DataPackage> localCache = new ConcurrentHashMap<>();
    private final long cacheTimeout = 10 * 60 * 1000; // 10分钟
    
    public void demonstratePerformanceOptimization() {
        System.out.println("MES集成性能优化实践");
        
        // 1. 本地缓存
        System.out.println("1. 本地缓存优化");
        useLocalCaching();
        
        // 2. 连接池管理
        System.out.println("2. 连接管理优化");
        manageConnections();
        
        // 3. 批量操作
        System.out.println("3. 批量操作优化");
        optimizeBatchOperations();
        
        // 4. 异步处理
        System.out.println("4. 异步处理优化");
        useAsyncProcessing();
    }
    
    private void useLocalCaching() {
        // 检查本地缓存
        String cacheKey = "DATA_PKG_20250821_001";
        CachedDataPackage cached = (CachedDataPackage) localCache.get(cacheKey);
        
        if (cached != null && !cached.isExpired()) {
            System.out.println("从本地缓存获取数据包: " + cacheKey);
            return;
        }
        
        // 从MES集成器获取
        // MesIntegrator.DataPackage dataPackage = MesIntegrator.getDataPackage(packageId);
        // if (dataPackage != null) {
        //     localCache.put(cacheKey, new CachedDataPackage(dataPackage, System.currentTimeMillis() + cacheTimeout));
        // }
        
        System.out.println("本地缓存优化示例完成");
    }
    
    private void manageConnections() {
        System.out.println("连接管理优化:");
        
        // 获取连接统计信息
        MesIntegrator.ConnectionStatistics stats = MesIntegrator.getConnectionStatistics();
        
        if (stats.isConnected()) {
            System.out.println("  连接正常，无需重新连接");
        } else {
            System.out.println("  连接断开，尝试重新连接");
            // 实际应用中应该尝试重新连接
        }
        
        System.out.println("  连接超时设置: " + stats.getConnectionTimeout() + "ms");
    }
    
    private void optimizeBatchOperations() {
        System.out.println("批量操作优化:");
        
        // 创建批量数据
        List<MesIntegrator.DataPackage> packages = new ArrayList<>();
        for (int i = 0; i < 100; i++) {
            // 添加数据包到列表
        }
        
        // 使用批量同步方法
        long startTime = System.currentTimeMillis();
        List<MesIntegrator.SyncResult> results = MesIntegrator.syncBatchDataToMes(packages);
        long endTime = System.currentTimeMillis();
        
        System.out.println("  批量同步 " + packages.size() + " 个数据包");
        System.out.println("  耗时: " + (endTime - startTime) + "ms");
        System.out.println("  平均每个数据包: " + (endTime - startTime) / (double) packages.size() + "ms");
    }
    
    private void useAsyncProcessing() {
        System.out.println("异步处理优化:");
        
        // 创建异步任务执行器
        ExecutorService executor = Executors.newFixedThreadPool(10);
        
        // 提交多个异步任务
        List<CompletableFuture<MesIntegrator.SyncResult>> futures = new ArrayList<>();
        
        for (int i = 0; i < 20; i++) {
            final int taskId = i;
            CompletableFuture<MesIntegrator.SyncResult> future = CompletableFuture.supplyAsync(() -> {
                // 模拟数据同步操作
                try {
                    Thread.sleep(100 + (long) (Math.random() * 200));
                    // return MesIntegrator.syncDataToMes(createDummyDataPackage(taskId));
                } catch (Exception e) {
                    e.printStackTrace();
                }
                return null;
            }, executor);
            
            futures.add(future);
        }
        
        // 等待所有任务完成
        CompletableFuture<Void> allDone = CompletableFuture.allOf(
            futures.toArray(new CompletableFuture[0])
        );
        
        try {
            allDone.get(30, TimeUnit.SECONDS);
            System.out.println("  所有异步任务完成");
        } catch (Exception e) {
            System.err.println("  异步任务执行超时或异常: " + e.getMessage());
        } finally {
            executor.shutdown();
        }
    }
    
    // 缓存数据包类
    private static class CachedDataPackage {
        private final MesIntegrator.DataPackage dataPackage;
        private final long expireTime;
        
        public CachedDataPackage(MesIntegrator.DataPackage dataPackage, long expireTime) {
            this.dataPackage = dataPackage;
            this.expireTime = expireTime;
        }
        
        public boolean isExpired() {
            return System.currentTimeMillis() > expireTime;
        }
        
        public MesIntegrator.DataPackage getDataPackage() {
            return dataPackage;
        }
    }
}
```

## 9. 系统集成

### 9.1 与Spring框架集成

```java
@Component
public class SpringMesIntegrationService {
    
    @Autowired
    private MesIntegrator mesIntegrator; // 假设MesIntegrator被Spring管理
    
    // 数据同步服务
    public MesIntegrator.SyncResult syncProductionData(ProductionDataDto dataDto) {
        // 转换DTO到DataPackage
        MesIntegrator.DataPackage dataPackage = convertToDataPackage(dataDto);
        
        // 执行同步
        return MesIntegrator.syncDataToMes(dataPackage);
    }
    
    // 指令处理服务
    @Async
    public CompletableFuture<MesIntegrator.CommandResponse> processCommandAsync(
            MesIntegrator.MesCommand command) {
        MesIntegrator.CommandResponse response = MesIntegrator.processMesCommand(command);
        return CompletableFuture.completedFuture(response);
    }
    
    // 实时数据推送服务
    @Scheduled(fixedRate = 5000) // 每5秒推送一次
    public void pushRealTimeData() {
        // 收集实时数据
        Map<String, Object> realTimeData = collectRealTimeData();
        
        // 推送数据
        MesIntegrator.pushRealTimeData(
            MesIntegrator.RealTimeTopic.PRODUCTION_STATUS.name(), 
            realTimeData
        );
    }
    
    // 异常处理服务
    @EventListener
    public void handleSystemException(SystemExceptionEvent event) {
        MesIntegrator.ExceptionData exceptionData = new MesIntegrator.ExceptionData(
            MesIntegrator.ExceptionType.SYSTEM_UNAVAILABLE,
            event.getSourceSystem(),
            "MES",
            event.getMessage()
        );
        
        MesIntegrator.reportExceptionData(exceptionData);
    }
    
    // 私有辅助方法
    private MesIntegrator.DataPackage convertToDataPackage(ProductionDataDto dataDto) {
        MesIntegrator.DataPackage dataPackage = MesIntegrator.createDataPackage(
            MesIntegrator.DataPackageType.PRODUCTION_DATA,
            dataDto.getSourceSystem(),
            "MES"
        );
        
        if (dataPackage != null) {
            dataPackage.setBatchId(dataDto.getBatchId())
                      .setProductId(dataDto.getProductId())
                      .setData("quantity", dataDto.getQuantity())
                      .setData("process_step", dataDto.getProcessStep());
        }
        
        return dataPackage;
    }
    
    private Map<String, Object> collectRealTimeData() {
        Map<String, Object> data = new HashMap<>();
        data.put("timestamp", System.currentTimeMillis());
        data.put("machine_status", "RUNNING");
        data.put("production_count", 1234);
        return data;
    }
}

// 数据传输对象
class ProductionDataDto {
    private String batchId;
    private String productId;
    private String sourceSystem;
    private int quantity;
    private String processStep;
    
    // Getters and Setters
    public String getBatchId() { return batchId; }
    public void setBatchId(String batchId) { this.batchId = batchId; }
    
    public String getProductId() { return productId; }
    public void setProductId(String productId) { this.productId = productId; }
    
    public String getSourceSystem() { return sourceSystem; }
    public void setSourceSystem(String sourceSystem) { this.sourceSystem = sourceSystem; }
    
    public int getQuantity() { return quantity; }
    public void setQuantity(int quantity) { this.quantity = quantity; }
    
    public String getProcessStep() { return processStep; }
    public void setProcessStep(String processStep) { this.processStep = processStep; }
}

// 系统异常事件
class SystemExceptionEvent extends ApplicationEvent {
    private final String sourceSystem;
    private final String message;
    
    public SystemExceptionEvent(Object source, String sourceSystem, String message) {
        super(source);
        this.sourceSystem = sourceSystem;
        this.message = message;
    }
    
    public String getSourceSystem() { return sourceSystem; }
    public String getMessage() { return message; }
}
```

### 9.2 与消息队列集成

```java
@Component
public class MessageQueueIntegration {
    
    // Kafka集成示例
    @KafkaListener(topics = "mes-commands", groupId = "mes-integrator-group")
    public void handleMesCommand(String commandJson) {
        try {
            // 解析JSON到MES指令对象
            MesIntegrator.MesCommand command = parseCommandFromJson(commandJson);
            
            // 处理MES指令
            MesIntegrator.CommandResponse response = MesIntegrator.processMesCommand(command);
            
            // 发送响应到响应队列
            sendResponseToQueue(response);
            
        } catch (Exception e) {
            System.err.println("处理MES指令时发生错误: " + e.getMessage());
            
            // 上报异常
            MesIntegrator.ExceptionData exceptionData = new MesIntegrator.ExceptionData(
                MesIntegrator.ExceptionType.DATA_FORMAT_ERROR,
                "MessageQueue",
                "MES",
                "指令JSON解析失败: " + e.getMessage()
            );
            
            MesIntegrator.reportExceptionData(exceptionData);
        }
    }
    
    @KafkaListener(topics = "production-data", groupId = "mes-integrator-group")
    public void handleProductionData(String dataJson) {
        try {
            // 解析JSON到数据包对象
            MesIntegrator.DataPackage dataPackage = parseDataPackageFromJson(dataJson);
            
            // 同步数据到MES
            MesIntegrator.SyncResult result = MesIntegrator.syncDataToMes(dataPackage);
            
            // 记录同步结果
            logSyncResult(result);
            
        } catch (Exception e) {
            System.err.println("处理生产数据时发生错误: " + e.getMessage());
        }
    }
    
    // RabbitMQ集成示例
    @RabbitListener(queues = "realtime-data-queue")
    public void handleRealTimeData(RealTimeDataMessage message) {
        try {
            // 推送实时数据到MES
            boolean pushed = MesIntegrator.pushRealTimeData(
                message.getTopic(), 
                message.getPayload()
            );
            
            if (!pushed) {
                System.err.println("实时数据推送失败: " + message.getTopic());
            }
            
        } catch (Exception e) {
            System.err.println("处理实时数据时发生错误: " + e.getMessage());
        }
    }
    
    // 私有辅助方法
    private MesIntegrator.MesCommand parseCommandFromJson(String json) {
        // 实现JSON到MES指令对象的解析
        // 这里简化处理，实际应用中应该使用Jackson或Gson等库
        return new MesIntegrator.MesCommand(
            MesIntegrator.CommandType.CUSTOM,
            "DEFAULT_EQUIPMENT",
            "SYSTEM"
        );
    }
    
    private MesIntegrator.DataPackage parseDataPackageFromJson(String json) {
        // 实现JSON到数据包对象的解析
        return MesIntegrator.createDataPackage(
            MesIntegrator.DataPackageType.CUSTOM,
            "SOURCE_SYSTEM",
            "MES"
        );
    }
    
    private void sendResponseToQueue(MesIntegrator.CommandResponse response) {
        // 实现发送响应到消息队列的逻辑
        System.out.println("发送指令响应到队列: " + response.getResponseId());
    }
    
    private void logSyncResult(MesIntegrator.SyncResult result) {
        if (result.isSuccess()) {
            System.out.println("数据同步成功: " + result.getPackageId());
        } else {
            System.err.println("数据同步失败: " + result.getMessage());
        }
    }
}

// 实时数据消息类
class RealTimeDataMessage {
    private String topic;
    private Object payload;
    private long timestamp;
    
    // Getters and Setters
    public String getTopic() { return topic; }
    public void setTopic(String topic) { this.topic = topic; }
    
    public Object getPayload() { return payload; }
    public void setPayload(Object payload) { this.payload = payload; }
    
    public long getTimestamp() { return timestamp; }
    public void setTimestamp(long timestamp) { this.timestamp = timestamp; }
}
```

这个使用说明文档涵盖了 [MesIntegrator](file://E:\dossier\others\im-common\src\main\java\com\qtech\im\semiconductor\integration\mes\MesIntegrator.java#L34-L1575)
的主要功能和使用方法，可以帮助开发者快速上手并正确使用该MES集成工具类。