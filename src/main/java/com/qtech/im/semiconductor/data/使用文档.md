# WaferMapParser 使用说明文档

## 1. 概述

[WaferMapParser](file://E:\dossier\others\im-common\src\main\java\com\qtech\im\semiconductor\data\WaferMapParser.java#L25-L198) 是一个专业的Wafer Map解析工具类，专门为半导体封测行业设计。该工具解决了不同厂商Wafer Map格式差异大、解析接口不统一、数据结构不规范等问题。

## 2. 核心功能

### 2.1 多格式支持
- 支持CDF(Common Data Format)格式解析
- 支持EDF(Equipment Data Format)格式解析
- 支持自动格式检测

### 2.2 数据结构规范化
- 统一的Die(芯片)数据结构
- 标准化的Wafer Map对象模型
- 规范的状态枚举和属性管理

### 2.3 统计分析
- 自动生成Wafer Map统计报告
- 按状态分类统计Die数量
- 计算良率(Yield)等关键指标

## 3. 支持的文件格式

### 3.1 格式类型枚举
```java
public enum WaferMapFormat {
    CDF,        // Common Data Format
    EDF,        // Equipment Data Format
    AUTO_DETECT // 自动检测格式
}
```


### 3.2 Die状态枚举
```java
public enum DieStatus {
    GOOD,       // 良品
    FAIL,       // 不良品
    EMPTY,      // 空白区域
    EDGE,       // 边缘区域
    UNKNOWN     // 未知状态
}
```


## 4. 基本使用方法

### 4.1 解析Wafer Map文件

```java
// Wafer Map解析示例
public class WaferMapParsingExample {
    public void parseWaferMapFiles() {
        System.out.println("开始Wafer Map解析示例...");
        
        // 1. 解析CDF格式文件
        System.out.println("1. 解析CDF格式文件:");
        String cdfFilePath = "data/wafer_map.cdf";
        WaferMapParser.WaferMap cdfWaferMap = 
            WaferMapParser.parseWaferMap(cdfFilePath, WaferMapParser.WaferMapFormat.CDF);
        
        if (cdfWaferMap != null) {
            System.out.println("  CDF文件解析成功");
            System.out.println("    Wafer尺寸: " + cdfWaferMap.getWaferSize() + "mm");
            System.out.println("    Die尺寸: " + cdfWaferMap.getDieSize() + "mm");
            System.out.println("    Die总数: " + cdfWaferMap.getDies().size());
        } else {
            System.err.println("  CDF文件解析失败");
        }
        
        // 2. 解析EDF格式文件
        System.out.println("\n2. 解析EDF格式文件:");
        String edfFilePath = "data/wafer_map.edf";
        WaferMapParser.WaferMap edfWaferMap = 
            WaferMapParser.parseWaferMap(edfFilePath, WaferMapParser.WaferMapFormat.EDF);
        
        if (edfWaferMap != null) {
            System.out.println("  EDF文件解析成功");
            System.out.println("    Wafer尺寸: " + edfWaferMap.getWaferSize() + "mm");
            System.out.println("    Die尺寸: " + edfWaferMap.getDieSize() + "mm");
            System.out.println("    Die总数: " + edfWaferMap.getDies().size());
        } else {
            System.err.println("  EDF文件解析失败");
        }
        
        // 3. 自动检测格式并解析
        System.out.println("\n3. 自动检测格式并解析:");
        String autoFilePath = "data/wafer_map_auto.dat";
        WaferMapParser.WaferMap autoWaferMap = 
            WaferMapParser.parseWaferMap(autoFilePath, WaferMapParser.WaferMapFormat.AUTO_DETECT);
        
        if (autoWaferMap != null) {
            System.out.println("  自动检测解析成功");
            System.out.println("    Wafer尺寸: " + autoWaferMap.getWaferSize() + "mm");
            System.out.println("    Die尺寸: " + autoWaferMap.getDieSize() + "mm");
            System.out.println("    Die总数: " + autoWaferMap.getDies().size());
        } else {
            System.err.println("  自动检测解析失败");
        }
        
        // 4. 解析未指定格式的文件（默认自动检测）
        System.out.println("\n4. 解析未指定格式的文件:");
        String unspecifiedFilePath = "data/wafer_map_unspecified.dat";
        WaferMapParser.WaferMap unspecifiedWaferMap = 
            WaferMapParser.parseWaferMap(unspecifiedFilePath, null);
        
        if (unspecifiedWaferMap != null) {
            System.out.println("  未指定格式解析成功");
        } else {
            System.err.println("  未指定格式解析失败");
        }
    }
}
```


### 4.2 创建和操作Wafer Map数据

```java
// Wafer Map数据操作示例
public class WaferMapDataOperationExample {
    public void operateWaferMapData() {
        System.out.println("开始Wafer Map数据操作示例...");
        
        // 1. 创建Wafer Map对象
        WaferMapParser.WaferMap waferMap = new WaferMapParser.WaferMap();
        waferMap.setWaferSize(300);  // 300mm wafer
        waferMap.setDieSize(5.0);    // 5mm die
        waferMap.setLotId("LOT20250820001");
        waferMap.setWaferId("WFR001");
        
        System.out.println("1. 创建Wafer Map对象:");
        System.out.println("  Wafer尺寸: " + waferMap.getWaferSize() + "mm");
        System.out.println("  Die尺寸: " + waferMap.getDieSize() + "mm");
        System.out.println("  批号: " + waferMap.getLotId());
        System.out.println("  Wafer ID: " + waferMap.getWaferId());
        
        // 2. 添加Die数据
        System.out.println("\n2. 添加Die数据:");
        // 添加一些良品Die
        for (int i = 0; i < 10; i++) {
            WaferMapParser.Die goodDie = new WaferMapParser.Die(i, i, WaferMapParser.DieStatus.GOOD);
            goodDie.setAttribute("testTime", 120 + i * 5);  // 测试时间
            goodDie.setAttribute("voltage", 3.3);           // 电压
            waferMap.addDie(goodDie);
        }
        
        // 添加一些不良品Die
        for (int i = 0; i < 5; i++) {
            WaferMapParser.Die failDie = new WaferMapParser.Die(i + 10, i, WaferMapParser.DieStatus.FAIL);
            failDie.setAttribute("failureMode", "OPEN");    // 失效模式
            failDie.setAttribute("resistance", 1000000);    // 电阻值
            waferMap.addDie(failDie);
        }
        
        // 添加一些边缘Die
        for (int i = 0; i < 3; i++) {
            WaferMapParser.Die edgeDie = new WaferMapParser.Die(i, i + 15, WaferMapParser.DieStatus.EDGE);
            edgeDie.setAttribute("distanceToEdge", 0.5);    // 到边缘距离
            waferMap.addDie(edgeDie);
        }
        
        System.out.println("  总共添加了 " + waferMap.getDies().size() + " 个Die");
        
        // 3. 查询和遍历Die数据
        System.out.println("\n3. 查询和遍历Die数据:");
        List<WaferMapParser.Die> dies = waferMap.getDies();
        
        // 按状态分类统计
        Map<WaferMapParser.DieStatus, Integer> statusCount = new EnumMap<>(WaferMapParser.DieStatus.class);
        for (WaferMapParser.Die die : dies) {
            WaferMapParser.DieStatus status = die.getStatus();
            statusCount.merge(status, 1, Integer::sum);
        }
        
        System.out.println("  Die状态统计:");
        for (Map.Entry<WaferMapParser.DieStatus, Integer> entry : statusCount.entrySet()) {
            System.out.println("    " + entry.getKey() + ": " + entry.getValue() + " 个");
        }
        
        // 查询特定坐标的Die
        System.out.println("\n  查询特定坐标的Die:");
        for (WaferMapParser.Die die : dies) {
            if (die.getX() == 0 && die.getY() == 0) {
                System.out.println("    坐标(0,0)的Die状态: " + die.getStatus());
                System.out.println("    属性: " + die.getAttributes());
                break;
            }
        }
        
        // 4. 修改Die属性
        System.out.println("\n4. 修改Die属性:");
        for (WaferMapParser.Die die : dies) {
            if (die.getStatus() == WaferMapParser.DieStatus.GOOD) {
                die.setAttribute("inspected", true);
                die.setAttribute("inspector", "AutoInspector");
            }
        }
        System.out.println("  已为所有良品Die添加检查属性");
    }
}
```


### 4.3 生成统计报告

```java
// Wafer Map统计报告示例
public class WaferMapReportingExample {
    public void generateWaferMapReports() {
        System.out.println("开始Wafer Map统计报告示例...");
        
        // 1. 创建示例Wafer Map数据
        WaferMapParser.WaferMap waferMap = createSampleWaferMap();
        
        // 2. 生成统计报告
        WaferMapParser.WaferMapReport report = WaferMapParser.generateReport(waferMap);
        
        if (report != null) {
            System.out.println("生成统计报告成功:");
            System.out.println("  总Die数: " + report.getTotalDies());
            System.out.println("  良品数: " + report.getGoodDies());
            System.out.println("  不良品数: " + report.getBadDies());
            System.out.println("  良率: " + String.format("%.2f", report.getYield() * 100) + "%");
            
            // 详细状态统计
            System.out.println("\n  详细状态统计:");
            Map<WaferMapParser.DieStatus, Integer> statusCounts = report.getStatusCounts();
            for (Map.Entry<WaferMapParser.DieStatus, Integer> entry : statusCounts.entrySet()) {
                double percentage = report.getTotalDies() > 0 ? 
                    (double) entry.getValue() / report.getTotalDies() * 100 : 0;
                System.out.println("    " + entry.getKey() + ": " + entry.getValue() + 
                                 " (" + String.format("%.1f", percentage) + "%)");
            }
        } else {
            System.err.println("生成统计报告失败");
        }
        
        // 3. 生成多个Wafer的对比报告
        System.out.println("\n3. 多个Wafer对比报告:");
        List<WaferMapParser.WaferMap> waferMaps = createMultipleSampleWaferMaps();
        List<WaferMapParser.WaferMapReport> reports = new ArrayList<>();
        
        for (int i = 0; i < waferMaps.size(); i++) {
            WaferMapParser.WaferMapReport rep = WaferMapParser.generateReport(waferMaps.get(i));
            if (rep != null) {
                reports.add(rep);
                System.out.println("  Wafer " + (i + 1) + ": 良率 " + 
                                 String.format("%.2f", rep.getYield() * 100) + "%");
            }
        }
        
        // 计算平均良率
        if (!reports.isEmpty()) {
            double totalYield = reports.stream().mapToDouble(WaferMapParser.WaferMapReport::getYield).sum();
            double averageYield = totalYield / reports.size();
            System.out.println("  平均良率: " + String.format("%.2f", averageYield * 100) + "%");
        }
    }
    
    private WaferMapParser.WaferMap createSampleWaferMap() {
        WaferMapParser.WaferMap waferMap = new WaferMapParser.WaferMap();
        waferMap.setWaferSize(300);
        waferMap.setDieSize(5.0);
        waferMap.setLotId("LOT20250820001");
        waferMap.setWaferId("WFR001");
        
        // 添加100个良品Die
        for (int i = 0; i < 100; i++) {
            WaferMapParser.Die die = new WaferMapParser.Die(i % 10, i / 10, WaferMapParser.DieStatus.GOOD);
            die.setAttribute("testTime", 120 + (i % 10));
            waferMap.addDie(die);
        }
        
        // 添加10个不良品Die
        for (int i = 0; i < 10; i++) {
            WaferMapParser.Die die = new WaferMapParser.Die(i, i + 10, WaferMapParser.DieStatus.FAIL);
            die.setAttribute("failureMode", "SHORT");
            waferMap.addDie(die);
        }
        
        // 添加5个边缘Die
        for (int i = 0; i < 5; i++) {
            WaferMapParser.Die die = new WaferMapParser.Die(i + 10, i, WaferMapParser.DieStatus.EDGE);
            die.setAttribute("distanceToEdge", 0.3);
            waferMap.addDie(die);
        }
        
        return waferMap;
    }
    
    private List<WaferMapParser.WaferMap> createMultipleSampleWaferMaps() {
        List<WaferMapParser.WaferMap> waferMaps = new ArrayList<>();
        
        // 创建3个不同的Wafer Map用于对比
        for (int w = 1; w <= 3; w++) {
            WaferMapParser.WaferMap waferMap = new WaferMapParser.WaferMap();
            waferMap.setWaferSize(300);
            waferMap.setDieSize(5.0);
            waferMap.setLotId("LOT20250820001");
            waferMap.setWaferId("WFR00" + w);
            
            // 每个Wafer有不同数量的Die
            int goodCount = 90 + w * 5;  // 95, 100, 105
            int failCount = 10 - w;      // 9, 8, 7
            
            // 添加良品Die
            for (int i = 0; i < goodCount; i++) {
                WaferMapParser.Die die = new WaferMapParser.Die(i % 10, i / 10, WaferMapParser.DieStatus.GOOD);
                waferMap.addDie(die);
            }
            
            // 添加不良品Die
            for (int i = 0; i < failCount; i++) {
                WaferMapParser.Die die = new WaferMapParser.Die(i, i + 10, WaferMapParser.DieStatus.FAIL);
                waferMap.addDie(die);
            }
            
            waferMaps.add(waferMap);
        }
        
        return waferMaps;
    }
}
```


## 5. 高级使用示例

### 5.1 完整的Wafer Map处理流程

```java
public class CompleteWaferMapProcessing {
    public void executeCompleteProcessing() {
        try {
            System.out.println("=== 开始完整的Wafer Map处理流程 ===");
            
            // 步骤1: 初始化处理环境
            System.out.println("\n步骤1: 初始化处理环境");
            initializeProcessingEnvironment();
            
            // 步骤2: 解析Wafer Map文件
            System.out.println("\n步骤2: 解析Wafer Map文件");
            WaferMapParser.WaferMap waferMap = parseWaferMapFile();
            
            if (waferMap == null) {
                System.err.println("Wafer Map解析失败，流程终止");
                return;
            }
            
            // 步骤3: 验证Wafer Map数据
            System.out.println("\n步骤3: 验证Wafer Map数据");
            boolean isValid = validateWaferMap(waferMap);
            if (!isValid) {
                System.err.println("Wafer Map数据验证失败，流程终止");
                return;
            }
            
            // 步骤4: 分析Wafer Map数据
            System.out.println("\n步骤4: 分析Wafer Map数据");
            analyzeWaferMap(waferMap);
            
            // 步骤5: 生成统计报告
            System.out.println("\n步骤5: 生成统计报告");
            WaferMapParser.WaferMapReport report = generateStatisticalReport(waferMap);
            
            // 步骤6: 导出报告
            System.out.println("\n步骤6: 导出报告");
            exportReport(report);
            
            // 步骤7: 数据清理
            System.out.println("\n步骤7: 数据清理");
            cleanupProcessingData();
            
            System.out.println("\n=== Wafer Map处理流程完成 ===");
            
        } catch (Exception e) {
            System.err.println("Wafer Map处理流程执行过程中发生错误: " + e.getMessage());
            e.printStackTrace();
        }
    }
    
    private void initializeProcessingEnvironment() {
        System.out.println("初始化处理环境...");
        
        // 检查必要配置
        System.out.println("  检查系统配置");
        System.out.println("  初始化日志系统");
        System.out.println("  准备临时存储空间");
        
        // 显示默认参数
        System.out.println("  默认Wafer尺寸: " + WaferMapParser.DEFAULT_WAFER_SIZE + "mm");
        System.out.println("  默认Die尺寸: " + WaferMapParser.DEFAULT_DIE_SIZE + "mm");
    }
    
    private WaferMapParser.WaferMap parseWaferMapFile() {
        System.out.println("解析Wafer Map文件...");
        
        // 模拟文件路径
        String filePath = "data/sample_wafer_map.cdf";
        System.out.println("  文件路径: " + filePath);
        
        // 使用自动检测解析
        WaferMapParser.WaferMap waferMap = 
            WaferMapParser.parseWaferMap(filePath, WaferMapParser.WaferMapFormat.AUTO_DETECT);
        
        if (waferMap != null) {
            System.out.println("  文件解析成功");
            System.out.println("    Wafer ID: " + waferMap.getWaferId());
            System.out.println("    批号: " + waferMap.getLotId());
            System.out.println("    Die数量: " + waferMap.getDies().size());
        } else {
            System.err.println("  文件解析失败");
        }
        
        return waferMap;
    }
    
    private boolean validateWaferMap(WaferMapParser.WaferMap waferMap) {
        System.out.println("验证Wafer Map数据...");
        
        // 基本验证
        if (waferMap == null) {
            System.err.println("  Wafer Map对象为空");
            return false;
        }
        
        // 验证必要属性
        if (waferMap.getWaferSize() <= 0) {
            System.err.println("  Wafer尺寸无效: " + waferMap.getWaferSize());
            return false;
        }
        
        if (waferMap.getDieSize() <= 0) {
            System.err.println("  Die尺寸无效: " + waferMap.getDieSize());
            return false;
        }
        
        // 验证Die数据
        List<WaferMapParser.Die> dies = waferMap.getDies();
        if (dies.isEmpty()) {
            System.err.println("  没有Die数据");
            return false;
        }
        
        System.out.println("  数据验证通过");
        System.out.println("    包含 " + dies.size() + " 个Die");
        return true;
    }
    
    private void analyzeWaferMap(WaferMapParser.WaferMap waferMap) {
        System.out.println("分析Wafer Map数据...");
        
        List<WaferMapParser.Die> dies = waferMap.getDies();
        
        // 按状态统计
        Map<WaferMapParser.DieStatus, Long> statusCount = dies.stream()
                .collect(Collectors.groupingBy(
                    WaferMapParser.Die::getStatus,
                    Collectors.counting()
                ));
        
        System.out.println("  状态分布:");
        statusCount.forEach((status, count) -> 
            System.out.println("    " + status + ": " + count + " 个"));
        
        // 计算坐标范围
        OptionalInt minX = dies.stream().mapToInt(WaferMapParser.Die::getX).min();
        OptionalInt maxX = dies.stream().mapToInt(WaferMapParser.Die::getX).max();
        OptionalInt minY = dies.stream().mapToInt(WaferMapParser.Die::getY).min();
        OptionalInt maxY = dies.stream().mapToInt(WaferMapParser.Die::getY).max();
        
        if (minX.isPresent() && maxX.isPresent() && minY.isPresent() && maxY.isPresent()) {
            System.out.println("  坐标范围: X(" + minX.getAsInt() + " to " + maxX.getAsInt() + 
                             "), Y(" + minY.getAsInt() + " to " + maxY.getAsInt() + ")");
        }
        
        // 分析属性
        Set<String> allAttributes = new HashSet<>();
        for (WaferMapParser.Die die : dies) {
            allAttributes.addAll(die.getAttributes().keySet());
        }
        System.out.println("  发现属性类型: " + allAttributes.size() + " 种");
    }
    
    private WaferMapParser.WaferMapReport generateStatisticalReport(WaferMapParser.WaferMap waferMap) {
        System.out.println("生成统计报告...");
        
        WaferMapParser.WaferMapReport report = WaferMapParser.generateReport(waferMap);
        
        if (report != null) {
            System.out.println("  报告生成成功");
            System.out.println("    总Die数: " + report.getTotalDies());
            System.out.println("    良品数: " + report.getGoodDies());
            System.out.println("    不良品数: " + report.getBadDies());
            System.out.println("    良率: " + String.format("%.2f", report.getYield() * 100) + "%");
        } else {
            System.err.println("  报告生成失败");
        }
        
        return report;
    }
    
    private void exportReport(WaferMapParser.WaferMapReport report) {
        System.out.println("导出报告...");
        
        if (report == null) {
            System.err.println("  报告为空，无法导出");
            return;
        }
        
        // 模拟导出过程
        System.out.println("  导出为CSV格式");
        System.out.println("  导出为PDF报告");
        System.out.println("  生成可视化图表");
        
        System.out.println("  报告导出完成");
    }
    
    private void cleanupProcessingData() {
        System.out.println("清理处理数据...");
        
        System.out.println("  释放内存资源");
        System.out.println("  清理临时文件");
        System.out.println("  关闭数据连接");
        
        System.out.println("  数据清理完成");
    }
}
```


### 5.2 Wafer Map数据分析

```java
public class WaferMapDataAnalysis {
    public void analyzeWaferMapData() {
        System.out.println("=== Wafer Map数据分析 ===");
        
        // 分析Die状态分布
        analyzeDieStatusDistribution();
        
        // 分析良率趋势
        analyzeYieldTrends();
        
        // 分析空间分布
        analyzeSpatialDistribution();
        
        // 分析属性相关性
        analyzeAttributeCorrelations();
        
        System.out.println("=== 数据分析完成 ===");
    }
    
    private void analyzeDieStatusDistribution() {
        System.out.println("\n分析Die状态分布:");
        
        // 模拟多个Wafer的数据
        Map<WaferMapParser.DieStatus, Integer> overallStatusCount = new EnumMap<>(WaferMapParser.DieStatus.class);
        
        // 模拟数据
        overallStatusCount.put(WaferMapParser.DieStatus.GOOD, 1250);
        overallStatusCount.put(WaferMapParser.DieStatus.FAIL, 85);
        overallStatusCount.put(WaferMapParser.DieStatus.EMPTY, 200);
        overallStatusCount.put(WaferMapParser.DieStatus.EDGE, 65);
        overallStatusCount.put(WaferMapParser.DieStatus.UNKNOWN, 0);
        
        int totalDies = overallStatusCount.values().stream().mapToInt(Integer::intValue).sum();
        
        System.out.println("  总Die数: " + totalDies);
        System.out.println("  状态分布:");
        for (Map.Entry<WaferMapParser.DieStatus, Integer> entry : overallStatusCount.entrySet()) {
            double percentage = (double) entry.getValue() / totalDies * 100;
            System.out.println("    " + entry.getKey() + ": " + entry.getValue() + 
                             " (" + String.format("%.1f", percentage) + "%)");
        }
    }
    
    private void analyzeYieldTrends() {
        System.out.println("\n分析良率趋势:");
        
        // 模拟多个批次的良率数据
        Map<String, Double> yieldByLot = new LinkedHashMap<>();
        yieldByLot.put("LOT20250801", 0.925);
        yieldByLot.put("LOT20250802", 0.932);
        yieldByLot.put("LOT20250803", 0.918);
        yieldByLot.put("LOT20250804", 0.941);
        yieldByLot.put("LOT20250805", 0.937);
        
        System.out.println("  批次良率:");
        yieldByLot.forEach((lot, yield) -> 
            System.out.println("    " + lot + ": " + String.format("%.2f", yield * 100) + "%"));
        
        // 计算平均良率
        double averageYield = yieldByLot.values().stream().mapToDouble(Double::doubleValue).average().orElse(0.0);
        System.out.println("  平均良率: " + String.format("%.2f", averageYield * 100) + "%");
        
        // 找出最高和最低良率
        Optional<Map.Entry<String, Double>> maxYield = yieldByLot.entrySet().stream()
                .max(Map.Entry.comparingByValue());
        Optional<Map.Entry<String, Double>> minYield = yieldByLot.entrySet().stream()
                .min(Map.Entry.comparingByValue());
        
        maxYield.ifPresent(entry -> 
            System.out.println("  最高良率: " + entry.getKey() + " (" + String.format("%.2f", entry.getValue() * 100) + "%)"));
        minYield.ifPresent(entry -> 
            System.out.println("  最低良率: " + entry.getKey() + " (" + String.format("%.2f", entry.getValue() * 100) + "%)"));
    }
    
    private void analyzeSpatialDistribution() {
        System.out.println("\n分析空间分布:");
        
        // 模拟Wafer上的缺陷分布
        System.out.println("  缺陷空间分布分析:");
        System.out.println("    中心区域缺陷密度: 中等");
        System.out.println("    边缘区域缺陷密度: 较高");
        System.out.println("    特定角度缺陷聚集: 45度方向存在聚集");
        
        // 模拟热点区域识别
        System.out.println("  热点区域识别:");
        System.out.println("    区域A(坐标5,5附近): 缺陷密集");
        System.out.println("    区域B(坐标15,10附近): 缺陷密集");
        System.out.println("    建议重点检查这些区域");
    }
    
    private void analyzeAttributeCorrelations() {
        System.out.println("\n分析属性相关性:");
        
        // 模拟属性相关性分析
        System.out.println("  属性相关性分析:");
        System.out.println("    测试时间与缺陷状态: 弱相关");
        System.out.println("    电压值与缺陷类型: 中等相关");
        System.out.println("    温度与良率: 负相关");
        
        System.out.println("  关键影响因素:");
        System.out.println("    1. 工艺参数稳定性");
        System.out.println("    2. 设备状态");
        System.out.println("    3. 材料质量");
    }
}
```


## 6. 配置参数详解

### 6.1 系统级配置参数

```java
public class WaferMapParserConfig {
    // 默认Wafer尺寸（毫米）
    public static final int DEFAULT_WAFER_SIZE = 300; // 300mm wafer
    
    // 默认Die尺寸（毫米）
    public static final double DEFAULT_DIE_SIZE = 5.0; // 5mm die
    
    // 最大支持的Die数量
    public static final int MAX_DIE_COUNT = 100000; // 100K dies
    
    // 解析超时时间（毫秒）
    public static final long PARSING_TIMEOUT = 30000; // 30秒
    
    // 内存使用限制（字节）
    public static final long MEMORY_LIMIT = 1024 * 1024 * 100; // 100MB
}
```


### 6.2 格式支持说明

```java
public class FormatSupportDetails {
    /*
     * CDF格式 (Common Data Format):
     * - 标准化的半导体测试数据格式
     * - 支持完整的Wafer Map信息
     * - 包含测试结果和统计信息
     * 
     * EDF格式 (Equipment Data Format):
     * - 设备特定的数据格式
     * - 通常由测试设备生成
     * - 格式可能因厂商而异
     * 
     * AUTO_DETECT自动检测:
     * - 根据文件头信息自动识别格式
     * - 支持常见的Wafer Map格式
     * - 提高使用的便利性
     */
    
    public static void explainFormatSupport() {
        System.out.println("格式支持说明:");
        System.out.println("CDF格式: 标准化的通用数据格式，兼容性好");
        System.out.println("EDF格式: 设备特定格式，可能需要特殊处理");
        System.out.println("AUTO_DETECT: 自动检测格式，使用方便");
    }
}
```


## 7. 错误处理

### 7.1 异常处理示例

```java
public class WaferMapParserErrorHandler {
    public void handleParserErrors() {
        System.out.println("Wafer Map解析器错误处理示例");
        
        try {
            // 尝试解析不存在的文件
            String invalidFilePath = "data/nonexistent_file.cdf";
            WaferMapParser.WaferMap waferMap = 
                WaferMapParser.parseWaferMap(invalidFilePath, WaferMapParser.WaferMapFormat.CDF);
            
            if (waferMap == null) {
                System.err.println("文件解析失败，已正确处理错误");
            }
            
            // 尝试解析损坏的文件
            String corruptedFilePath = "data/corrupted_wafer_map.cdf";
            WaferMapParser.WaferMap corruptedMap = 
                WaferMapParser.parseWaferMap(corruptedFilePath, WaferMapParser.WaferMapFormat.CDF);
            
            if (corruptedMap == null) {
                System.err.println("损坏文件解析失败，已正确处理错误");
            }
            
        } catch (Exception e) {
            System.err.println("解析器使用过程中发生异常: " + e.getMessage());
            e.printStackTrace();
        }
    }
    
    public boolean safeWaferMapParsing(String filePath, WaferMapParser.WaferMapFormat format) {
        if (filePath == null || filePath.isEmpty()) {
            System.err.println("文件路径不能为空");
            return false;
        }
        
        if (format == null) {
            format = WaferMapParser.WaferMapFormat.AUTO_DETECT;
        }
        
        int maxAttempts = 3;
        int attemptCount = 0;
        
        while (attemptCount < maxAttempts) {
            try {
                WaferMapParser.WaferMap waferMap = WaferMapParser.parseWaferMap(filePath, format);
                
                if (waferMap != null) {
                    System.out.println("Wafer Map解析成功");
                    return true;
                } else {
                    System.err.println("第" + (attemptCount + 1) + "次解析失败");
                }
                
            } catch (Exception e) {
                System.err.println("第" + (attemptCount + 1) + "次解析异常: " + e.getMessage());
            }
            
            attemptCount++;
            
            // 重试前等待
            if (attemptCount < maxAttempts) {
                try {
                    Thread.sleep(1000 * attemptCount); // 递增延迟
                } catch (InterruptedException e) {
                    Thread.currentThread().interrupt();
                    break;
                }
            }
        }
        
        System.err.println("Wafer Map解析最终失败，已重试 " + maxAttempts + " 次");
        return false;
    }
}
```


## 8. 最佳实践

### 8.1 数据处理最佳实践

```java
public class DataProcessingBestPractices {
    public void demonstrateBestPractices() {
        System.out.println("Wafer Map数据处理最佳实践演示");
        
        // 1. 数据验证
        System.out.println("1. 数据验证");
        validateDataIntegrity();
        
        // 2. 内存管理
        System.out.println("2. 内存管理");
        manageMemoryEfficiently();
        
        // 3. 错误恢复
        System.out.println("3. 错误恢复");
        implementErrorRecovery();
        
        // 4. 性能优化
        System.out.println("4. 性能优化");
        optimizePerformance();
    }
    
    private void validateDataIntegrity() {
        System.out.println("数据完整性验证实践:");
        
        // 验证必要字段
        System.out.println("  验证Wafer Map必要字段");
        
        // 验证数据范围
        System.out.println("  验证数据值的有效范围");
        
        // 验证数据一致性
        System.out.println("  验证数据之间的一致性");
    }
    
    private void manageMemoryEfficiently() {
        System.out.println("内存管理实践:");
        
        // 分批处理大数据
        System.out.println("  分批处理大型Wafer Map");
        
        // 及时释放不需要的对象
        System.out.println("  及时释放处理完成的对象");
        
        // 使用对象池减少GC压力
        System.out.println("  使用对象池优化内存使用");
    }
    
    private void implementErrorRecovery() {
        System.out.println("错误恢复实践:");
        
        // 实现重试机制
        System.out.println("  实现解析失败重试机制");
        
        // 部分失败处理
        System.out.println("  支持部分数据解析失败的处理");
        
        // 详细错误日志
        System.out.println("  记录详细的错误信息便于排查");
    }
    
    private void optimizePerformance() {
        System.out.println("性能优化实践:");
        
        // 并行处理多个文件
        System.out.println("  并行处理多个Wafer Map文件");
        
        // 缓存常用计算结果
        System.out.println("  缓存统计分析结果");
        
        // 避免重复计算
        System.out.println("  避免重复的数据处理计算");
    }
}
```


### 8.2 性能优化实践

```java
public class PerformanceOptimization {
    public void demonstratePerformanceOptimization() {
        System.out.println("Wafer Map解析性能优化实践");
        
        // 1. 批量处理
        System.out.println("1. 批量处理优化");
        optimizeBatchProcessing();
        
        // 2. 并行处理
        System.out.println("2. 并行处理优化");
        useParallelProcessing();
        
        // 3. 缓存机制
        System.out.println("3. 缓存机制优化");
        implementCaching();
        
        // 4. 内存优化
        System.out.println("4. 内存优化");
        optimizeMemoryUsage();
    }
    
    private void optimizeBatchProcessing() {
        System.out.println("批量处理优化:");
        
        // 批量解析多个文件
        List<String> filePaths = Arrays.asList(
            "data/wafer1.cdf",
            "data/wafer2.cdf",
            "data/wafer3.cdf"
        );
        
        System.out.println("  批量解析 " + filePaths.size() + " 个Wafer Map文件");
        System.out.println("  减少重复的初始化开销");
        System.out.println("  提高整体处理效率");
    }
    
    private void useParallelProcessing() {
        System.out.println("并行处理优化:");
        
        // 使用并行流处理多个Wafer Map
        List<String> filePaths = Arrays.asList(
            "data/wafer1.cdf",
            "data/wafer2.cdf",
            "data/wafer3.cdf"
        );
        
        System.out.println("  使用并行处理解析多个文件");
        System.out.println("  充分利用多核CPU性能");
        System.out.println("  提高大批量数据处理速度");
    }
    
    private void implementCaching() {
        System.out.println("缓存机制优化:");
        
        // 缓存解析结果
        System.out.println("  缓存已解析的Wafer Map数据");
        
        // 缓存统计报告
        System.out.println("  缓存生成的统计报告");
        
        // 合理设置缓存超时
        System.out.println("  合理设置缓存有效期");
    }
    
    private void optimizeMemoryUsage() {
        System.out.println("内存优化:");
        
        // 及时释放大对象
        System.out.println("  及时释放处理完成的大对象");
        
        // 使用基本数据类型
        System.out.println("  优先使用基本数据类型而非包装类");
        
        // 避免内存泄漏
        System.out.println("  避免静态集合持有大对象引用");
    }
}
```


## 9. 系统集成

### 9.1 与Spring框架集成

```java
@Component
public class SpringWaferMapService {
    
    // Wafer Map解析服务
    public WaferMapParser.WaferMap parseWaferMap(String filePath, WaferMapParser.WaferMapFormat format) {
        return WaferMapParser.parseWaferMap(filePath, format);
    }
    
    // Wafer Map统计报告服务
    @Async
    public CompletableFuture<WaferMapParser.WaferMapReport> generateReportAsync(WaferMapParser.WaferMap waferMap) {
        return CompletableFuture.completedFuture(WaferMapParser.generateReport(waferMap));
    }
    
    // 批量处理服务
    @Scheduled(fixedRate = 3600000) // 每小时执行一次
    public void batchProcessWaferMaps() {
        // 获取待处理的Wafer Map文件列表
        // List<String> filePaths = getPendingWaferMapFiles();
        
        // for (String filePath : filePaths) {
        //     WaferMapParser.WaferMap waferMap = WaferMapParser.parseWaferMap(filePath, WaferMapParser.WaferMapFormat.AUTO_DETECT);
        //     if (waferMap != null) {
        //         WaferMapParser.WaferMapReport report = WaferMapParser.generateReport(waferMap);
        //         if (report != null) {
        //             // 保存报告到数据库
        //             saveReportToDatabase(report);
        //         }
        //     }
        // }
        
        System.out.println("定时批量处理Wafer Map文件");
    }
    
    // 数据导出服务
    public void exportWaferMapData(WaferMapParser.WaferMap waferMap, String exportFormat) {
        // 实现数据导出逻辑
        System.out.println("导出Wafer Map数据为 " + exportFormat + " 格式");
    }
}
```


### 9.2 与消息队列集成

```java
@Component
public class MessageQueueIntegration {
    
    // Kafka集成示例
    @KafkaListener(topics = "wafer-map-files", groupId = "wafer-map-processor")
    public void handleWaferMapFile(String filePath) {
        try {
            // 解析Wafer Map文件
            WaferMapParser.WaferMap waferMap = 
                WaferMapParser.parseWaferMap(filePath, WaferMapParser.WaferMapFormat.AUTO_DETECT);
            
            if (waferMap != null) {
                // 生成统计报告
                WaferMapParser.WaferMapReport report = WaferMapParser.generateReport(waferMap);
                
                if (report != null) {
                    // 发送报告到其他系统
                    sendReport(report);
                }
            }
        } catch (Exception e) {
            System.err.println("处理Wafer Map文件时发生错误: " + e.getMessage());
        }
    }
    
    @KafkaListener(topics = "wafer-map-reports", groupId = "wafer-map-analyzer")
    public void handleWaferMapReport(String reportJson) {
        try {
            // 解析JSON到报告对象
            WaferMapReportMessage reportMessage = parseReportFromJson(reportJson);
            
            // 进行进一步分析
            analyzeReport(reportMessage);
            
        } catch (Exception e) {
            System.err.println("处理Wafer Map报告时发生错误: " + e.getMessage());
        }
    }
    
    // RabbitMQ集成示例
    @RabbitListener(queues = "wafer-map-analysis-queue")
    public void handleWaferMapAnalysis(WaferMapAnalysisRequest request) {
        try {
            // 执行特定分析任务
            performAnalysis(request);
            
        } catch (Exception e) {
            System.err.println("执行Wafer Map分析时发生错误: " + e.getMessage());
        }
    }
    
    // 私有辅助方法
    private WaferMapReportMessage parseReportFromJson(String json) {
        // 实现JSON到报告对象的解析
        return new WaferMapReportMessage("LOT001", "WFR001", 0.95);
    }
    
    private void sendReport(WaferMapParser.WaferMapReport report) {
        System.out.println("发送报告到其他系统");
        // 实现报告发送逻辑
    }
    
    private void analyzeReport(WaferMapReportMessage reportMessage) {
        System.out.println("分析Wafer Map报告: " + reportMessage.getLotId());
        // 实现报告分析逻辑
    }
    
    private void performAnalysis(WaferMapAnalysisRequest request) {
        System.out.println("执行分析任务: " + request.getAnalysisType());
        // 实现具体分析逻辑
    }
}

// Wafer Map报告消息类
class WaferMapReportMessage {
    private String lotId;
    private String waferId;
    private double yield;
    private long timestamp;
    
    public WaferMapReportMessage(String lotId, String waferId, double yield) {
        this.lotId = lotId;
        this.waferId = waferId;
        this.yield = yield;
        this.timestamp = System.currentTimeMillis();
    }
    
    // Getters and Setters
    public String getLotId() { return lotId; }
    public void setLotId(String lotId) { this.lotId = lotId; }
    
    public String getWaferId() { return waferId; }
    public void setWaferId(String waferId) { this.waferId = waferId; }
    
    public double getYield() { return yield; }
    public void setYield(double yield) { this.yield = yield; }
    
    public long getTimestamp() { return timestamp; }
    public void setTimestamp(long timestamp) { this.timestamp = timestamp; }
}

// Wafer Map分析请求类
class WaferMapAnalysisRequest {
    private String lotId;
    private String waferId;
    private String analysisType;
    private Map<String, Object> parameters;
    private long timestamp;
    
    // Getters and Setters
    public String getLotId() { return lotId; }
    public void setLotId(String lotId) { this.lotId = lotId; }
    
    public String getWaferId() { return waferId; }
    public void setWaferId(String waferId) { this.waferId = waferId; }
    
    public String getAnalysisType() { return analysisType; }
    public void setAnalysisType(String analysisType) { this.analysisType = analysisType; }
    
    public Map<String, Object> getParameters() { return parameters; }
    public void setParameters(Map<String, Object> parameters) { this.parameters = parameters; }
    
    public long getTimestamp() { return timestamp; }
    public void setTimestamp(long timestamp) { this.timestamp = timestamp; }
}
```


这个使用说明文档涵盖了 [WaferMapParser](file://E:\dossier\others\im-common\src\main\java\com\qtech\im\semiconductor\data\WaferMapParser.java#L25-L198) 的主要功能和使用方法，可以帮助开发者快速上手并正确使用该Wafer Map解析工具类。