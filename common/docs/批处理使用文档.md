# IM Common Batch Framework 使用文档

## 概述

IM Common Batch Framework 是一个功能强大、可扩展的批处理框架，提供了统一的批处理作业管理、执行引擎、配置管理和监控功能。该框架支持多种批处理场景，包括标准批处理、并行处理和大数据处理。

## 核心组件

### 1. 配置管理 (config)

#### BatchConfig

批处理作业配置类，定义了批处理作业的各项配置参数。

```java
// 创建配置实例
BatchConfig config = new BatchConfig();
config.setBatchSize(1000);
config.setRetryCount(3);
config.setRetryDelayMs(1000);
config.setContinueOnError(false);

// 使用构建器模式创建配置
BatchConfig config = BatchConfig.builder()
    .batchSize(500)
    .retryCount(5)
    .retryDelayMs(2000)
    .continueOnError(true)
    .build();
```

### 2. 核心接口 (core)

#### BatchJob<T, R>

批处理作业接口，定义了批处理作业的核心行为。

#### BatchJobManager

批处理作业管理器接口，提供作业的统一管理功能。

#### BatchJobStatus

批处理作业状态枚举，定义了作业的生命周期状态。

### 3. 执行引擎 (engine)

#### BatchEngine<T, R>

抽象批处理执行引擎，定义了执行引擎的基础行为。

#### StandardBatchEngine<T>

标准批处理引擎，基于标准批处理器实现。

#### SparkBatchEngine

Spark批处理引擎（待实现）。

### 4. 处理器 (processor)

#### BatchProcessor

通用批量处理工具类，提供分批处理和并行处理功能。

```java
// 分批处理数据
List<BatchProcessor.BatchResult<String>> results = BatchProcessor.processInBatches(
    data, 
    batch -> processBatch(batch),
    config
);

// 并行处理数据
List<String> results = BatchProcessor.processParallel(
    data,
    item -> processItem(item),
    threadCount
);
```

### 5. 监控 (monitor)

#### JobMetrics

作业执行指标类，记录作业执行过程中的各项指标数据。

## 使用示例

### 1. 基本批处理作业

```java
// 创建批处理引擎
BatchConfig config = BatchConfig.builder()
    .batchSize(100)
    .retryCount(3)
    .build();

StandardBatchEngine<String> engine = new StandardBatchEngine<>("DataProcessor", config);

// 准备数据
List<String> data = Arrays.asList("item1", "item2", "item3");

// 定义处理器
Consumer<List<String>> processor = batch -> {
    for (String item : batch) {
        System.out.println("Processing: " + item);
    }
};

// 执行批处理
List<BatchProcessor.BatchResult<String>> results = engine.executeBatch(data, processor);
```

### 2. 自定义批处理作业

```java
public class CustomBatchJob extends BatchEngine<List<String>, List<BatchProcessor.BatchResult<String>>> {

    private final BatchConfig config;

    public CustomBatchJob(String jobName, BatchConfig config) {
        super(jobName);
        this.config = config != null ? config : new BatchConfig();
    }

    @Override
    public List<BatchProcessor.BatchResult<String>> execute(List<String> input) throws Exception {
        updateStatus(BatchJobStatus.RUNNING);
        metrics.start();

        try {
            List<BatchProcessor.BatchResult<String>> results = BatchProcessor.processInBatches(
                    input,
                    this::processBatch,
                    config
            );

            updateStatus(BatchJobStatus.SUCCESS);
            metrics.finish();
            return results;
        } catch (Exception e) {
            updateStatus(BatchJobStatus.FAILED);
            metrics.fail(e);
            throw e;
        }
    }

    private void processBatch(List<String> batch) {
        // 实现具体的批次处理逻辑
        for (String item : batch) {
            // 处理单个数据项
            System.out.println("Processing item: " + item);
        }
    }

    @Override
    public BatchConfig getConfig() {
        return config;
    }
}
```

### 3. 并行处理示例

```java
// 并行处理大量数据
List<Integer> data = IntStream.range(1, 10000).boxed().collect(Collectors.toList());

Function<Integer, String> processor = item -> {
    // 模拟处理耗时
    try {
        Thread.sleep(10);
    } catch (InterruptedException e) {
        Thread.currentThread().interrupt();
    }
    return "Processed: " + item;
};

// 使用默认线程数进行并行处理
List<String> results = BatchProcessor.processParallel(data, processor);

// 使用指定线程数进行并行处理
List<String> results2 = BatchProcessor.processParallel(data, processor, 8);
```

## 最佳实践

### 1. 配置管理

- 根据数据量和处理复杂度合理设置批处理大小
- 设置适当的重试次数和重试延迟
- 在生产环境中启用错误日志记录

### 2. 异常处理

- 实现适当的异常处理机制
- 记录详细的错误日志便于问题排查
- 考虑使用 [continueOnError](file://E:\dossier\others\im-framework\common\src\main\java\org\im\common\batch\config\BatchConfig.java#L48-L48) 配置控制错误处理策略

### 3. 性能优化

- 根据系统资源合理设置并发线程数
- 对于大数据量处理，考虑使用流式处理
- 监控作业执行指标，持续优化性能

### 4. 监控和日志

- 充分利用 [JobMetrics](file://E:\dossier\others\im-framework\common\src\main\java\org\im\common\batch\monitor\JobMetrics.java#L18-L129) 进行性能监控
- 记录关键操作日志
- 定期分析作业执行情况

## 扩展性

### 1. 自定义执行引擎

可以通过继承 [BatchEngine](file://E:\dossier\others\im-framework\common\src\main\java\org\im\common\batch\engine\BatchEngine.java#L25-L113) 类创建自定义执行引擎，满足特定业务需求。

### 2. 集成其他处理框架

可以集成 Spark、Flink 等大数据处理框架，通过实现相应的引擎类。

### 3. 定制配置

通过扩展 [BatchConfig](file://E:\dossier\others\im-framework\common\src\main\java\org\im\common\batch\config\BatchConfig.java#L18-L159) 或创建自定义配置类满足特定需求。

## 包结构说明

```
org.im.common.batch
├── config                  # 配置管理
├── core                    # 核心接口
├── engine                  # 执行引擎
├── exception               # 异常处理
├── monitor                 # 监控指标
├── processor               # 处理器
├── schedule                # 调度管理
└── util                    # 工具类
```

## 注意事项

1. 确保正确配置线程池大小，避免资源耗尽
2. 合理设置批处理大小，平衡内存使用和处理效率
3. 注意异常处理，避免因单个批次失败影响整体处理
4. 在生产环境中充分测试各种配置参数
5. 定期监控和分析作业执行指标，持续优化性能