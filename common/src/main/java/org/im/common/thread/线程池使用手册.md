# IM Framework 线程池框架使用手册

## 1. 简介

IM Framework 线程池框架是一个智能线程池管理组件，专为IoT和智能制造场景设计。该框架提供了多优先级线程池管理、虚拟线程支持、智能拒绝策略等功能，能够有效管理不同类型的并发任务。

### 1.1 核心特性

- **多优先级支持**：支持重要(IMPORTANT)、普通(NORMAL)、低优先级(LOW)和虚拟线程(VIRTUAL)任务处理
- **虚拟线程兼容**：兼容Java 21虚拟线程和传统平台线程
- **智能拒绝策略**：根据任务优先级采用不同的拒绝处理策略
- **任务类型分类**：针对IoT/智能制造场景定义了多种任务类型
- **配置管理集成**：与IM Framework配置管理组件集成，支持外部化配置
- **状态监控**：提供线程池运行状态监控功能

## 2. 核心组件

### 2.1 ThreadPoolFrameworkProperties（线程池配置属性）

线程池框架的核心配置类，用于定义各种线程池的参数。

```java
// 使用默认配置
ThreadPoolFrameworkProperties properties = new ThreadPoolFrameworkProperties();

// 使用自定义配置管理器
ConfigurationManager configManager = new DefaultConfigurationManager();
ThreadPoolFrameworkProperties properties = new ThreadPoolFrameworkProperties(configManager);
```


### 2.2 NativeThreadPoolExecutor（原生线程池执行器）

基于Java原生线程池实现的执行器，支持不同优先级的任务处理。

### 2.3 VirtualThreadPoolExecutor（虚拟线程执行器）

支持Java 21虚拟线程的执行器，在不支持虚拟线程的环境中会自动回退到平台线程。

### 2.4 ThreadPoolManager（线程池管理器）

提供线程池的统一管理和缓存复用机制。

### 2.5 HybridTaskDispatcher（混合任务调度器）

结合优先级分类和任务类型的混合调度器。

## 3. 快速开始

### 3.1 添加依赖

在项目中添加必要的依赖（假设有相应的Maven依赖配置）。

### 3.2 基本使用

```java
import org.im.common.thread.config.ThreadPoolFrameworkProperties;
import org.im.common.thread.core.ThreadPoolManager;
import org.im.common.thread.core.SmartThreadPoolExecutor;
import org.im.common.thread.task.TaskPriority;

// 创建线程池配置
ThreadPoolFrameworkProperties properties = new ThreadPoolFrameworkProperties();

// 创建线程池管理器
ThreadPoolManager manager = new ThreadPoolManager(properties);

// 获取线程池执行器
SmartThreadPoolExecutor executor = manager.getExecutor("important");

// 执行任务
executor.execute(() -> {
    // 任务逻辑
    System.out.println("Task executed in thread: " + Thread.currentThread().getName());
});

// 关闭线程池
manager.shutdown();
```


### 3.3 使用混合调度器

```java
import org.im.common.thread.factory.ThreadPoolFactory;
import org.im.common.thread.task.HybridTaskDispatcher;
import org.im.common.thread.task.TaskPriority;
import org.im.common.thread.task.TaskType;

// 创建工厂和调度器
ThreadPoolFactory factory = new ThreadPoolFactory(properties);
HybridTaskDispatcher dispatcher = new HybridTaskDispatcher(factory, properties);

// 按优先级调度任务
dispatcher.dispatch(() -> {
    System.out.println("Important task executed");
}, TaskPriority.IMPORTANT);

// 按优先级和任务类型调度任务
dispatcher.dispatch(() -> {
    System.out.println("Batch processing task executed");
}, TaskPriority.NORMAL, TaskType.BATCH_PROCESSING);

// 关闭所有执行器
dispatcher.shutdown();
```


## 4. 配置管理

### 4.1 默认配置

线程池框架提供了一套合理的默认配置：

- **重要线程池**：核心线程数5，最大线程数10，队列容量100
- **普通线程池**：核心线程数5，最大线程数10，队列容量100
- **低优先级线程池**：核心线程数5，最大线程数10，队列容量100
- **虚拟线程**：最大并发数100

### 4.2 外部化配置

通过配置管理组件，可以使用外部配置覆盖默认值。支持的配置项包括：

```properties
# 虚拟线程配置
thread.pool.virtual.enabled=true
thread.pool.virtual.max.concurrency=200
thread.pool.virtual.thread.name.prefix=vthread-

# 重要线程池配置
thread.pool.important.core.size=10
thread.pool.important.max.size=20
thread.pool.important.queue.capacity=200
thread.pool.important.keep.alive.seconds=30
thread.pool.important.thread.name.prefix=imp-

# 普通线程池配置
thread.pool.normal.core.size=5
thread.pool.normal.max.size=15
thread.pool.normal.queue.capacity=100
thread.pool.normal.keep.alive.seconds=60
thread.pool.normal.thread.name.prefix=norm-

# 低优先级线程池配置
thread.pool.low.core.size=2
thread.pool.low.max.size=5
thread.pool.low.queue.capacity=50
thread.pool.low.keep.alive.seconds=120
thread.pool.low.thread.name.prefix=low-

# 监控配置
thread.pool.monitor.enabled=true
thread.pool.monitor.log.interval.seconds=600
```


### 4.3 编程方式配置

```java
ThreadPoolFrameworkProperties properties = new ThreadPoolFrameworkProperties();

// 配置重要线程池
properties.getImportant().setCorePoolSize(10);
properties.getImportant().setMaxPoolSize(20);

// 配置虚拟线程
properties.setVirtualThreadEnabled(true);
properties.getVirtual().setMaxConcurrency(200);
```


## 5. 任务优先级和类型

### 5.1 任务优先级

框架定义了四种任务优先级：

- [IMPORTANT](file://E:\dossier\others\im-framework\common\src\main\java\org\im\common\thread\task\TaskPriority.java#L11-L11)：重要任务，如设备控制、传感器监控
- [NORMAL](file://E:\dossier\others\im-framework\qtech\datadev\datadev-common\src\main\java\com\im\qtech\data\dto\reverse\LabelEum.java#L15-L15)：普通任务，如数据处理、实时分析
- [LOW](file://E:\dossier\others\im-framework\common\src\main\java\org\im\common\thread\task\TaskPriority.java#L13-L13)：低优先级任务，如系统维护、日志清理
- [VIRTUAL](file://E:\dossier\others\im-framework\common\src\main\java\org\im\common\thread\task\TaskPriority.java#L14-L14)：虚拟线程任务，适用于高并发、I/O密集型任务

### 5.2 任务类型

框架针对IoT和智能制造场景定义了多种任务类型：

```java
public enum TaskType {
    // 实时控制类 (最高优先级)
    DEVICE_CONTROL(1, "设备控制"),
    SENSOR_MONITORING(2, "传感器监控"),

    // 数据处理类 (高优先级)
    DATA_PROCESSING(3, "数据处理"),
    REALTIME_ANALYTICS(4, "实时分析"),

    // 批处理类 (普通优先级)
    BATCH_PROCESSING(5, "批处理"),
    REPORT_GENERATION(6, "报表生成"),

    // 系统维护类 (低优先级)
    SYSTEM_MAINTENANCE(7, "系统维护"),
    LOG_CLEANUP(8, "日志清理");
}
```


## 6. 智能拒绝策略

框架根据不同优先级采用不同的拒绝策略：

- **重要任务**：阻塞等待，直到任务被接受
- **普通任务**：在调用者线程中执行
- **低优先级任务**：直接丢弃

## 7. 最佳实践

### 7.1 线程池选择策略

1. **实时控制任务**（如设备控制、传感器监控）：使用重要线程池
2. **数据处理任务**（如数据分析、报表生成）：使用普通线程池
3. **批处理任务**：可考虑使用虚拟线程执行器
4. **系统维护任务**：使用低优先级线程池

### 7.2 配置优化建议

1. **根据业务负载调整线程池大小**：
   - 重要任务线程池应保证足够的核心线程数
   - 普通任务线程池可以适当调整最大线程数
   - 低优先级任务线程池可以设置较小的线程数

2. **合理设置队列容量**：
   - 高优先级任务队列不宜过小，避免频繁拒绝
   - 低优先级任务队列可以适当减小

3. **虚拟线程使用**：
   - 适用于I/O密集型、高并发场景
   - 合理设置最大并发数，避免资源耗尽

### 7.3 监控和维护

```java
// 获取线程池状态
ThreadPoolStatus status = executor.getStatus();
System.out.println("Active threads: " + status.getActiveCount());
System.out.println("Queue size: " + status.getQueueSize());

// 定期监控线程池状态
ScheduledExecutorService scheduler = Executors.newScheduledThreadPool(1);
scheduler.scheduleAtFixedRate(() -> {
    ThreadPoolStatus status = executor.getStatus();
    // 记录或告警逻辑
}, 0, 30, TimeUnit.SECONDS);
```


### 7.4 异常处理

```java
executor.execute(() -> {
    try {
        // 业务逻辑
    } catch (Exception e) {
        // 统一异常处理
        logger.error("Task execution failed", e);
    }
});
```


### 7.5 资源管理

1. **及时关闭线程池**：在应用关闭时确保调用[shutdown()](file://E:\dossier\others\im-framework\qtech\inspection\eq-aa-lst-chk\src\main\java\com\im\aa\inspection\EqLstInspectionApp.java#L136-L153)方法
2. **避免线程泄漏**：确保所有创建的线程池都被正确关闭
3. **合理复用线程池**：使用[ThreadPoolManager](file://E:\dossier\others\im-framework\common\src\main\java\org\im\common\thread\core\ThreadPoolManager.java#L25-L65)来管理和复用线程池实例

## 8. 故障排除

### 8.1 任务被拒绝

- 检查线程池配置是否合理
- 查看日志中拒绝策略的执行情况
- 考虑增加线程池大小或队列容量

### 8.2 性能问题

- 监控线程池活跃线程数和队列大小
- 分析任务执行时间，是否存在长时间运行的任务
- 考虑使用虚拟线程处理高并发I/O密集型任务

### 8.3 虚拟线程不工作

- 确认运行环境是否支持Java 21虚拟线程
- 检查`thread.pool.virtual.enabled`配置是否为true
- 查看日志中是否有虚拟线程创建失败的信息

## 9. 扩展示例

### 9.1 自定义拒绝策略

```java
public class CustomRejectionHandler implements RejectedExecutionHandler {
    @Override
    public void rejectedExecution(Runnable r, ThreadPoolExecutor executor) {
        // 自定义拒绝处理逻辑
        logger.warn("Task rejected by executor: {}", executor);
        // 可以选择重试、记录日志、发送告警等
    }
}
```


### 9.2 动态调整线程池配置

```java
// 监听配置变更
configManager.addConfigurationListener(event -> {
    if (event.getKey().startsWith("thread.pool.")) {
        // 重新加载线程池配置
        properties.loadConfiguration();
        // 重新创建线程池或动态调整参数
    }
});
```


## 10. 注意事项

1. **线程池生命周期管理**：确保正确创建和关闭线程池，避免资源泄漏
2. **任务执行时间**：避免在线程池中执行长时间运行的任务，影响其他任务调度
3. **异常处理**：在线程池任务中要妥善处理异常，避免线程意外终止
4. **配置优先级**：外部配置会覆盖默认配置，确保配置项的正确性
5. **虚拟线程兼容性**：在不支持虚拟线程的环境中会自动回退到平台线程